{% extends 'base.html' %}
{% block content %}
<h1 class="mb-4">Leitstellen Interface</h1>
<h2>Status ändern</h2>
<form id="dispatch-form" class="row g-3 mb-4">
    <div class="col-md-4">
        <label class="form-label" for="dispatch-unit">Fahrzeug</label>
        <select name="unit" id="dispatch-unit" class="form-select">
            {% for name in vehicles.keys() %}
            <option value="{{ name }}">{{ name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label" for="dispatch-status">Status</label>
        <select name="status" id="dispatch-status" class="form-select">
            {% for code, text in status_text.items() %}
            <option value="{{ code }}">{{ code }} - {{ text }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label" for="dispatch-location">Ort</label>
        <input type="text" name="location" id="dispatch-location" class="form-control">
    </div>
    <div class="col-12">
        <button type="submit" class="btn btn-primary">Senden</button>
    </div>
</form>
<div id="result" class="mt-3 mb-4"></div>

<h2 class="mt-5 d-flex justify-content-between align-items-center">Einsätze <button class="btn btn-danger btn-sm" id="incident-new">Einsatz anlegen</button></h2>
<table class="table table-striped" id="incident-list">
  <thead>
    <tr><th>ID</th><th>Start</th><th>Fahrzeuge</th><th>Ort</th><th>Stichwort</th><th>Aktiv</th><th>Notizen</th><th>Protokoll</th><th>Aktion</th></tr>
  </thead>
  <tbody>
  {% for inc in incidents %}
    <tr data-id="{{ inc.id }}">
      <td>{{ inc.id }}</td>
      <td>{{ inc.start }}</td>
      <td>{{ inc.vehicles|join(', ') }}</td>
      <td>{{ inc.location.name }}</td>
      <td>{{ inc.keyword }}</td>
      <td>{{ 'Ja' if inc.active else 'Nein' }}</td>
      <td>
        <ul class="list-unstyled mb-2">
          {% for n in inc.notes %}
          <li>{{ n.time }} - {{ n.text }}</li>
          {% endfor %}
        </ul>
      </td>
      <td>
        <ul class="list-unstyled mb-2">
          {% for l in inc.log or [] %}
          <li>{{ l.time }} - {{ l.unit }}: {{ l.status if l.status is string else l.status ~ ' - ' ~ status_text[l.status] }}</li>
          {% endfor %}
        </ul>
      </td>
      <td>
        <button class="btn btn-sm btn-primary edit">Bearbeiten</button>
        {% if inc.active %}
        <button class="btn btn-sm btn-success end">Beenden</button>
        {% endif %}
        <button class="btn btn-sm btn-danger delete">Löschen</button>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<!-- Incident detail modal -->
<div class="modal fade" id="incident-modal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Einsatz</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="incident-form">
          <input type="hidden" name="id">
          <div class="mb-3">
            <label class="form-label" for="incident-start">Start</label>
            <input type="text" name="start" id="incident-start" class="form-control" readonly>
          </div>
          <h6>Einsatzdaten</h6>
          <div class="mb-3">
            <label class="form-label" for="incident-template">Vorlage</label>
            <select name="template" id="incident-template" class="form-select">
              <option value="">--</option>
              {% for t in templates %}
              <option value="{{ t.id }}">{{ t.label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label" for="incident-keyword">Stichwort</label>
            <input type="text" name="keyword" id="incident-keyword" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label" for="incident-location">Ort</label>
            <input type="text" name="location" id="incident-location" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label" for="incident-priority">Priorität</label>
            <select name="priority" id="incident-priority" class="form-select">
              <option value="">--</option>
              <option value="R0">R0</option>
              <option value="R1">R1</option>
              <option value="R2">R2</option>
              <option value="R3">R3</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label" for="incident-patient">Patient</label>
            <input type="text" name="patient" id="incident-patient" class="form-control">
          </div>
          <h6>Fahrzeugzuordnung</h6>
          <div class="mb-3">
          {% for name, info in vehicles.items() %}
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="vehicles" value="{{ name }}" id="iv{{ loop.index }}">
              <label class="form-check-label" for="iv{{ loop.index }}">{{ name }}</label>
            </div>
          {% endfor %}
          </div>
          <div class="mb-3">
            <label class="form-label" for="incident-note">Notiz</label>
            <textarea name="note" id="incident-note" class="form-control" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
        <button type="button" class="btn btn-primary" id="incident-save">Speichern</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
const form = document.getElementById('dispatch-form');
const vehiclesData = {{ vehicles|tojson }};
const availableData = {{ available|tojson }};
const unitSelect = form.querySelector('select[name="unit"]');
const statusSelect = form.querySelector('select[name="status"]');
const locationInput = form.querySelector('input[name="location"]');
function updateStatusSelect() {
    const unit = unitSelect.value;
    if (vehiclesData[unit]) {
        statusSelect.value = vehiclesData[unit].status;
        locationInput.value = vehiclesData[unit].location || '';
    }
}
unitSelect.addEventListener('change', updateStatusSelect);
updateStatusSelect();
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const payload = Object.fromEntries(formData.entries());
    if (!payload.location) delete payload.location;
    try {
        const res = await fetch('/api/dispatch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        document.getElementById('result').textContent = data.ok ? 'Gesendet' : 'Fehler';
    } catch (err) {
        document.getElementById('result').textContent = 'Fehler';
    }
});

const incidentModal = new bootstrap.Modal(document.getElementById('incident-modal'));
function fillIncidentModal(inc) {
  const f = document.getElementById('incident-form');
  f.reset();
  f.elements['id'].value = inc.id || '';
  f.start.value = inc.start ? new Date(inc.start).toLocaleString('de-DE') : '';
  f.keyword.value = inc.keyword || '';
  f.location.value = (inc.location && inc.location.name) || '';
  f.priority.value = inc.priority || '';
  f.patient.value = inc.patient || '';
  f.note.value = '';
  f.template.value = '';
  f.querySelectorAll('input[name="vehicles"]').forEach(cb => {
    cb.checked = inc.vehicles && inc.vehicles.includes(cb.value);
    cb.disabled = !availableData[cb.value] && !cb.checked;
  });
  document.querySelector('#incident-modal .modal-title').textContent = inc.id ? 'Einsatz bearbeiten' : 'Einsatz anlegen';
}
document.getElementById('incident-new').addEventListener('click', () => {
  fillIncidentModal({});
  incidentModal.show();
});
document.querySelectorAll('#incident-list .edit').forEach(btn => {
  btn.addEventListener('click', async e => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    const res = await fetch(`/api/incidents/${id}`);
    const inc = await res.json();
    fillIncidentModal(inc);
    incidentModal.show();
  });
});

document.getElementById('incident-save').addEventListener('click', async () => {
  const f = document.getElementById('incident-form');
  const id = f.elements['id'].value;
  const payload = {
    keyword: f.keyword.value,
    location: f.location.value,
    priority: f.priority.value,
    patient: f.patient.value,
    vehicles: Array.from(f.querySelectorAll('input[name="vehicles"]:checked')).map(cb => cb.value)
  };
  const note = f.note.value.trim();
  if (note) payload.note = note;
  const url = id ? `/api/incidents/${id}` : '/api/incidents';
  const method = id ? 'PUT' : 'POST';
  const res = await fetch(url, {
    method,
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });
  const r = await res.json();
  if (r.ok) {
    incidentModal.hide();
    window.location.reload();
  }
});

const templateList = {{ templates|tojson }};
const templateMap = {};
templateList.forEach(t => { templateMap[t.id] = t; });
document.querySelector('#incident-form [name="template"]').addEventListener('change', (e) => {
  const f = document.getElementById('incident-form');
  const t = templateMap[e.target.value];
  if (t) {
    f.keyword.value = t.keyword || '';
    f.priority.value = t.priority || '';
  }
});
document.querySelectorAll('#incident-list .end').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    const res = await fetch(`/api/incidents/${id}/end`, {method: 'POST'});
    const r = await res.json();
    if (r.ok) {
      location.reload();
    }
  });
});

document.querySelectorAll('#incident-list .delete').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    const res = await fetch(`/api/incidents/${id}`, {method: 'DELETE'});
    const r = await res.json();
    if (r.ok) {
      location.reload();
    }
  });
});

const evtSource = new EventSource('/events');
evtSource.onmessage = () => window.location.reload();
</script>
{% endblock %}
