{% extends 'base.html' %}
{% block content %}
<h1 class="mb-4">Leitstellen Interface</h1>
<h2>Status ändern</h2>
<form id="dispatch-form" class="row g-3 mb-4">
    <div class="col-md-4">
        <label class="form-label">Fahrzeug</label>
        <select name="unit" class="form-select">
            {% for name in vehicles.keys() %}
            <option value="{{ name }}">{{ name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
            {% for code, text in status_text.items() %}
            <option value="{{ code }}">{{ code }} - {{ text }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-12">
        <button type="submit" class="btn btn-primary">Senden</button>
    </div>
</form>
<div id="result" class="mt-3 mb-4"></div>

<h2>Alarmierung</h2>
<form id="alarm-form" class="row g-3">
    <div class="col-md-3">
        <label class="form-label">Ort</label>
        <input type="text" name="location" class="form-control">
    </div>
    <div class="col-md-3">
        <label class="form-label">Stichwort</label>
        <input type="text" name="keyword" class="form-control">
    </div>
    <div class="col-md-6">
        <label class="form-label">Notiz</label>
        <textarea name="note" class="form-control" rows="2"></textarea>
    </div>
    <div class="col-12">
        <label class="form-label">Fahrzeuge</label>
        <div class="form-check">
        {% for name, info in vehicles.items() %}
            {% if info.status < 3 %}
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="vehicles" value="{{ name }}" id="v{{ loop.index }}">
                <label class="form-check-label" for="v{{ loop.index }}">{{ name }}</label>
            </div>
            {% endif %}
        {% endfor %}
        </div>
    </div>
    <div class="col-12">
        <button type="submit" class="btn btn-danger">Alarm auslösen</button>
    </div>
</form>
<div id="alarm-result" class="mt-3"></div>

<h2 class="mt-5">Einsätze</h2>
<table class="table table-striped" id="incident-list">
  <thead>
    <tr><th>ID</th><th>Start</th><th>Fahrzeuge</th><th>Ort</th><th>Stichwort</th><th>Aktiv</th><th>Notizen</th><th>Protokoll</th><th>Aktion</th></tr>
  </thead>
  <tbody>
  {% for inc in incidents %}
    <tr data-id="{{ inc.id }}">
      <td>{{ inc.id }}</td>
      <td>{{ inc.start }}</td>
      <td>{{ inc.vehicles|join(', ') }}</td>
      <td>{{ inc.location.name }}</td>
      <td>{{ inc.keyword }}</td>
      <td>{{ 'Ja' if inc.active else 'Nein' }}</td>
      <td>
        <ul class="list-unstyled mb-2">
          {% for n in inc.notes %}
          <li>{{ n.time }} - {{ n.text }}</li>
          {% endfor %}
        </ul>
        {% if inc.active %}
        <form class="note-form">
          <div class="input-group input-group-sm">
            <textarea name="text" class="form-control" rows="2" placeholder="Notiz"></textarea>
            <button class="btn btn-secondary" type="submit">Hinzufügen</button>
          </div>
        </form>
        {% endif %}
      </td>
      <td>
        <ul class="list-unstyled mb-2">
          {% for l in inc.log or [] %}
          <li>{{ l.time }} - {{ l.unit }}: {{ l.status if l.status is string else l.status ~ ' - ' ~ status_text[l.status] }}</li>
          {% endfor %}
        </ul>
        {% if inc.active %}
        <form class="alert-form">
          <div class="input-group input-group-sm">
            <select name="unit" class="form-select">
              {% for name, v in vehicles.items() %}
                {% if name not in inc.vehicles and v.status < 3 %}
                  <option value="{{ name }}">{{ name }}</option>
                {% endif %}
              {% endfor %}
            </select>
            <button class="btn btn-warning" type="submit">Mitalarmieren</button>
          </div>
        </form>
        {% endif %}
      </td>
      <td>
        {% if inc.active %}
        <button class="btn btn-sm btn-success end">Beenden</button>
        {% endif %}
        <button class="btn btn-sm btn-danger delete">Löschen</button>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<!-- Incident detail modal -->
<div class="modal fade" id="incident-modal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Einsatzdetails</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="incident-form">
          <input type="hidden" name="id">
          <div class="mb-3">
            <label class="form-label">Vorlage</label>
            <select name="template" class="form-select">
              <option value="">--</option>
              <option value="bma">Brandmeldeanlage</option>
              <option value="vu">Verkehrsunfall</option>
              <option value="rd">Medizinischer Notfall</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Stichwort</label>
            <input type="text" name="keyword" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Ort</label>
            <input type="text" name="location" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Priorität</label>
            <select name="priority" class="form-select">
              <option value="">--</option>
              <option value="R0">R0</option>
              <option value="R1">R1</option>
              <option value="R2">R2</option>
              <option value="R3">R3</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Patient</label>
            <input type="text" name="patient" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Notiz</label>
            <textarea name="note" class="form-control" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
        <button type="button" class="btn btn-primary" id="incident-save">Speichern</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
const form = document.getElementById('dispatch-form');
const vehiclesData = {{ vehicles|tojson }};
const unitSelect = form.querySelector('select[name="unit"]');
const statusSelect = form.querySelector('select[name="status"]');
function updateStatusSelect() {
    const unit = unitSelect.value;
    if (vehiclesData[unit]) {
        statusSelect.value = vehiclesData[unit].status;
    }
}
unitSelect.addEventListener('change', updateStatusSelect);
updateStatusSelect();
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const payload = Object.fromEntries(formData.entries());
    const res = await fetch('/api/dispatch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    const data = await res.json();
    document.getElementById('result').textContent = data.ok ? 'Gesendet' : 'Fehler';
});

const alarmForm = document.getElementById('alarm-form');
const incidentModal = new bootstrap.Modal(document.getElementById('incident-modal'));
function fillIncidentModal(inc) {
    const f = document.getElementById('incident-form');
    f.elements['id'].value = inc.id || '';
    f.keyword.value = inc.keyword || '';
    f.location.value = (inc.location && inc.location.name) || '';
    f.priority.value = inc.priority || '';
    f.patient.value = inc.patient || '';
    f.note.value = '';
    f.template.value = '';
}
alarmForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(alarmForm);
    const payload = Object.fromEntries(fd.entries());
    payload.vehicles = fd.getAll('vehicles');
    const res = await fetch('/api/incidents', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    const data = await res.json();
    document.getElementById('alarm-result').textContent = data.ok ? 'Alarm gesendet' : 'Fehler';
    if (data.ok) {
        const incRes = await fetch(`/api/incidents/${data.id}`);
        const incData = await incRes.json();
        fillIncidentModal(incData);
        incidentModal.show();
    }
});

document.querySelectorAll('#incident-list tbody tr').forEach(tr => {
  tr.addEventListener('dblclick', async () => {
    const id = tr.dataset.id;
    const res = await fetch(`/api/incidents/${id}`);
    const inc = await res.json();
    fillIncidentModal(inc);
    incidentModal.show();
  });
});

document.getElementById('incident-save').addEventListener('click', async () => {
  const f = document.getElementById('incident-form');
  const id = f.elements['id'].value;
  const payload = {
    keyword: f.keyword.value,
    location: {name: f.location.value},
    priority: f.priority.value,
    patient: f.patient.value
  };
  const note = f.note.value.trim();
  if (note) payload.note = note;
  const res = await fetch(`/api/incidents/${id}`, {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });
  const r = await res.json();
  if (r.ok) {
    incidentModal.hide();
    window.location.reload();
  }
});

const templateMap = {
  bma: {keyword: 'Brandmeldeanlage', priority: 'R1'},
  vu: {keyword: 'Verkehrsunfall', priority: 'R1'},
  rd: {keyword: 'Medizinischer Notfall', priority: 'R2'}
};
document.querySelector('#incident-form [name="template"]').addEventListener('change', (e) => {
  const f = document.getElementById('incident-form');
  const t = templateMap[e.target.value];
  if (t) {
    f.keyword.value = t.keyword;
    f.priority.value = t.priority;
  }
});

document.querySelectorAll('#incident-list .note-form').forEach(form => {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    const text = form.querySelector('[name="text"]').value;
    const res = await fetch(`/api/incidents/${id}/notes`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({text})
    });
    const r = await res.json();
    if (r.ok) {
      location.reload();
    }
  });
});

document.querySelectorAll('#incident-list .end').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    const res = await fetch(`/api/incidents/${id}/end`, {method: 'POST'});
    const r = await res.json();
    if (r.ok) {
      location.reload();
    }
  });
});

document.querySelectorAll('#incident-list .delete').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    const res = await fetch(`/api/incidents/${id}`, {method: 'DELETE'});
    const r = await res.json();
    if (r.ok) {
      location.reload();
    }
  });
});

document.querySelectorAll('#incident-list .alert-form').forEach(form => {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    const unit = form.querySelector('select[name="unit"]').value;
    const res = await fetch(`/api/incidents/${id}/alert`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({units: [unit]})
    });
    const r = await res.json();
    if (r.ok) {
      location.reload();
    }
  });
});

const evtSource = new EventSource('/events');
evtSource.onmessage = () => window.location.reload();
</script>
{% endblock %}
