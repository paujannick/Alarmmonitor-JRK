{% extends 'base.html' %}
{% block content %}
<h1 class="mb-4">Leitstellen Interface</h1>
<h2>Status ändern</h2>
<form id="dispatch-form" class="row g-3 mb-4">
    <div class="col-md-4">
        <label class="form-label">Fahrzeug</label>
        <select name="unit" class="form-select">
            {% for name in vehicles.keys() %}
            <option value="{{ name }}">{{ name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
            {% for code, text in status_text.items() %}
            <option value="{{ code }}">{{ code }} - {{ text }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-12">
        <button type="submit" class="btn btn-primary">Senden</button>
    </div>
</form>
<div id="result" class="mt-3 mb-4"></div>

<h2>Alarmierung</h2>
<form id="alarm-form" class="row g-3">
    <div class="col-md-3">
        <label class="form-label">Ort</label>
        <input type="text" name="location" class="form-control">
    </div>
    <div class="col-md-3">
        <label class="form-label">Stichwort</label>
        <input type="text" name="keyword" class="form-control">
    </div>
    <div class="col-md-6">
        <label class="form-label">Notiz</label>
        <textarea name="note" class="form-control" rows="2"></textarea>
    </div>
    <div class="col-12">
        <label class="form-label">Fahrzeuge</label>
        <div class="form-check">
        {% for name, info in vehicles.items() %}
            {% if info.status < 3 %}
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="vehicles" value="{{ name }}" id="v{{ loop.index }}">
                <label class="form-check-label" for="v{{ loop.index }}">{{ name }}</label>
            </div>
            {% endif %}
        {% endfor %}
        </div>
    </div>
    <div class="col-12">
        <button type="submit" class="btn btn-danger">Alarm auslösen</button>
    </div>
</form>
<div id="alarm-result" class="mt-3"></div>

<h2 class="mt-5">Einsätze</h2>
<table class="table table-striped" id="incident-list">
  <thead>
    <tr><th>ID</th><th>Start</th><th>Fahrzeuge</th><th>Ort</th><th>Stichwort</th><th>Aktiv</th><th>Notizen</th><th>Protokoll</th><th>Aktion</th></tr>
  </thead>
  <tbody>
  {% for inc in incidents %}
    <tr data-id="{{ inc.id }}">
      <td>{{ inc.id }}</td>
      <td>{{ inc.start }}</td>
      <td>{{ inc.vehicles|join(', ') }}</td>
      <td>{{ inc.location.name }}</td>
      <td>{{ inc.keyword }}</td>
      <td>{{ 'Ja' if inc.active else 'Nein' }}</td>
      <td>
        <ul class="list-unstyled mb-2">
          {% for n in inc.notes %}
          <li>{{ n.time }} - {{ n.text }}</li>
          {% endfor %}
        </ul>
        {% if inc.active %}
        <form class="note-form">
          <div class="input-group input-group-sm">
            <textarea name="text" class="form-control" rows="2" placeholder="Notiz"></textarea>
            <button class="btn btn-secondary" type="submit">Hinzufügen</button>
          </div>
        </form>
        {% endif %}
      </td>
      <td>
        <ul class="list-unstyled mb-2">
          {% for l in inc.log or [] %}
          <li>{{ l.time }} - {{ l.unit }}: {{ l.status if l.status is string else l.status ~ ' - ' ~ status_text[l.status] }}</li>
          {% endfor %}
        </ul>
        {% if inc.active %}
        <form class="alert-form">
          <div class="input-group input-group-sm">
            <select name="unit" class="form-select">
              {% for name, v in vehicles.items() %}
                {% if name not in inc.vehicles and v.status < 3 %}
                  <option value="{{ name }}">{{ name }}</option>
                {% endif %}
              {% endfor %}
            </select>
            <button class="btn btn-warning" type="submit">Mitalarmieren</button>
          </div>
        </form>
        {% endif %}
      </td>
      <td>
        {% if inc.active %}
        <button class="btn btn-sm btn-success end">Beenden</button>
        {% endif %}
        <button class="btn btn-sm btn-danger delete">Löschen</button>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endblock %}
{% block scripts %}
<script>
const form = document.getElementById('dispatch-form');
const vehiclesData = {{ vehicles|tojson }};
const unitSelect = form.querySelector('select[name="unit"]');
const statusSelect = form.querySelector('select[name="status"]');
function updateStatusSelect() {
    const unit = unitSelect.value;
    if (vehiclesData[unit]) {
        statusSelect.value = vehiclesData[unit].status;
    }
}
unitSelect.addEventListener('change', updateStatusSelect);
updateStatusSelect();
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const payload = Object.fromEntries(formData.entries());
    const res = await fetch('/api/dispatch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    const data = await res.json();
    document.getElementById('result').textContent = data.ok ? 'Gesendet' : 'Fehler';
});

const alarmForm = document.getElementById('alarm-form');
alarmForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(alarmForm);
    const payload = Object.fromEntries(fd.entries());
    payload.vehicles = fd.getAll('vehicles');
    const res = await fetch('/api/incidents', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    const data = await res.json();
    document.getElementById('alarm-result').textContent = data.ok ? 'Alarm gesendet' : 'Fehler';
});

document.querySelectorAll('#incident-list .note-form').forEach(form => {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    const text = form.querySelector('[name="text"]').value;
    const res = await fetch(`/api/incidents/${id}/notes`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({text})
    });
    const r = await res.json();
    if (r.ok) {
      location.reload();
    }
  });
});

document.querySelectorAll('#incident-list .end').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    const res = await fetch(`/api/incidents/${id}/end`, {method: 'POST'});
    const r = await res.json();
    if (r.ok) {
      location.reload();
    }
  });
});

document.querySelectorAll('#incident-list .delete').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    const res = await fetch(`/api/incidents/${id}`, {method: 'DELETE'});
    const r = await res.json();
    if (r.ok) {
      location.reload();
    }
  });
});

document.querySelectorAll('#incident-list .alert-form').forEach(form => {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    const unit = form.querySelector('select[name="unit"]').value;
    const res = await fetch(`/api/incidents/${id}/alert`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({units: [unit]})
    });
    const r = await res.json();
    if (r.ok) {
      location.reload();
    }
  });
});

const evtSource = new EventSource('/events');
evtSource.onmessage = () => window.location.reload();
</script>
{% endblock %}
