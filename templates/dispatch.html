{% extends 'base.html' %}
{% block content %}
<h1 class="mb-4">Leitstellen Interface</h1>
<h2>Status ändern</h2>
<form id="dispatch-form" class="row g-3 mb-4">
    <div class="col-md-4">
        <label class="form-label" for="dispatch-unit">Fahrzeug</label>
        <select name="unit" id="dispatch-unit" class="form-select">
            {% for name in vehicles.keys() %}
            <option value="{{ name }}">{{ name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label" for="dispatch-status">Status</label>
        <select name="status" id="dispatch-status" class="form-select">
            {% for code, text in status_text.items() %}
            <option value="{{ code }}">{{ code }} - {{ text }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label" for="dispatch-location">Ort</label>
        <input type="text" name="location" id="dispatch-location" class="form-control">
    </div>
    <div class="col-12">
        <button type="submit" class="btn btn-primary">Senden</button>
    </div>
</form>
<div id="result" class="mt-3 mb-4"></div>

<div class="alert alert-danger d-none" role="alert" id="dispatch-status-error"></div>

<h2 class="mt-5">Fahrzeugübersicht</h2>
<div id="dispatch-vehicle-board" class="status-grid">
  {% for name, info in vehicles.items() %}
  <div class="card status-card dispatch-card" data-unit="{{ name }}">
    <div class="card-header d-flex justify-content-between align-items-start">
      <div>
        <h5 class="card-title mb-0">{{ name }}</h5>
        <small class="text-muted">{{ info.callsign or info.name }}</small>
      </div>
      <span class="availability badge rounded-pill"></span>
    </div>
    <div class="card-body">
      <p class="current-status mb-3">
        <span class="badge bg-primary">Status {{ info.status }} – {{ status_text[info.status] }}</span>
      </p>
      <div class="dispatch-meta mb-3">
        <span class="meta-label">Ort</span>
        <span class="meta-value dispatch-location">{{ info.location or '—' }}</span>
      </div>
      <div class="dispatch-meta mb-3">
        <span class="meta-label">Stichwort</span>
        <span class="meta-value dispatch-note">{{ info.note or '—' }}</span>
      </div>
      <div class="dispatch-meta mb-3">
        <span class="meta-label">Priorität</span>
        <span class="meta-value dispatch-priority">{{ info.priority or '—' }}</span>
      </div>
      <div class="dispatch-meta mb-4">
        <span class="meta-label">Alarmiert</span>
        <span class="meta-value dispatch-alarm" data-raw="{{ info.alarm_time or '' }}">{{ info.alarm_time or '—' }}</span>
      </div>
      <div class="d-flex status-buttons">
        {% for code in [0, 1, 2, 3, 4, 5, 6] %}
        <button type="button" class="btn btn-sm status-btn {% if code == info.status %}btn-primary{% else %}btn-outline-secondary{% endif %}" data-status="{{ code }}" title="Status {{ code }} – {{ status_text[code] }}">
          {{ code }}
        </button>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<h2 class="mt-5 d-flex justify-content-between align-items-center">Einsätze <button class="btn btn-danger btn-sm" id="incident-new">Einsatz anlegen</button></h2>
<table class="table table-striped" id="incident-list">
  <thead>
    <tr><th>ID</th><th>Start</th><th>Fahrzeuge</th><th>Ort</th><th>Stichwort</th><th>Aktiv</th><th>Notizen</th><th>Protokoll</th><th>Aktion</th></tr>
  </thead>
  <tbody>
  {% for inc in incidents %}
    <tr data-id="{{ inc.id }}">
      <td>{{ inc.id }}</td>
      <td>{{ inc.start }}</td>
      <td>{{ inc.vehicles|join(', ') }}</td>
      <td>{{ inc.location.name }}</td>
      <td>{{ inc.keyword }}</td>
      <td>{{ 'Ja' if inc.active else 'Nein' }}</td>
      <td>
        <ul class="list-unstyled mb-2">
          {% for n in inc.notes %}
          <li>{{ n.time }} - {{ n.text }}</li>
          {% endfor %}
        </ul>
      </td>
      <td>
        <ul class="list-unstyled mb-2">
          {% for l in inc.log or [] %}
          <li>{{ l.time }} - {{ l.unit }}: {{ l.status if l.status is string else l.status ~ ' - ' ~ status_text[l.status] }}</li>
          {% endfor %}
        </ul>
      </td>
      <td>
        <button class="btn btn-sm btn-primary edit">Bearbeiten</button>
        {% if inc.active %}
        <button class="btn btn-sm btn-success end">Beenden</button>
        {% endif %}
        <button class="btn btn-sm btn-danger delete">Löschen</button>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<!-- Incident detail modal -->
<div class="modal fade" id="incident-modal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Einsatz</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="incident-form">
          <input type="hidden" name="id">
          <div class="mb-3">
            <label class="form-label" for="incident-start">Start</label>
            <input type="text" name="start" id="incident-start" class="form-control" readonly>
          </div>
          <h6>Einsatzdaten</h6>
          <div class="mb-3">
            <label class="form-label" for="incident-template">Vorlage</label>
            <select name="template" id="incident-template" class="form-select">
              <option value="">--</option>
              {% for t in templates %}
              <option value="{{ t.id }}">{{ t.label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label" for="incident-keyword">Stichwort</label>
            <input type="text" name="keyword" id="incident-keyword" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label" for="incident-location">Ort</label>
            <input type="text" name="location" id="incident-location" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label" for="incident-priority">Priorität</label>
            <select name="priority" id="incident-priority" class="form-select">
              <option value="">--</option>
              {% for prio in priority_options %}
              <option value="{{ prio }}">{{ prio }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label" for="incident-patient">Patient</label>
            <input type="text" name="patient" id="incident-patient" class="form-control">
          </div>
          <h6>Fahrzeugzuordnung</h6>
          <div class="mb-3">
          {% for name, info in vehicles.items() %}
            <div class="form-check form-check-inline align-items-center">
              <input class="form-check-input" type="checkbox" name="vehicles" value="{{ name }}" id="iv{{ loop.index }}">
              <label class="form-check-label me-2" for="iv{{ loop.index }}">{{ name }}</label>
              <input class="form-check-input alarm-check" type="checkbox" id="ialarm{{ loop.index }}" data-unit="{{ name }}" disabled {% if info.alarm_time %}checked{% endif %} title="Alarmiert">
            </div>
          {% endfor %}
          </div>
          <div class="mb-3">
            <label class="form-label" for="incident-note">Notiz</label>
            <textarea name="note" id="incident-note" class="form-control" rows="3"></textarea>
          </div>
        </form>
        <div class="alert alert-danger d-none" role="alert" id="incident-error"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
        <button type="button" class="btn btn-primary" id="incident-save">Speichern</button>
        <button type="button" class="btn btn-danger" id="incident-alert">Alarmieren</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
const form = document.getElementById('dispatch-form');
const vehiclesData = {{ vehicles|tojson }};
const availableData = {{ available|tojson }};
const statusText = {{ status_text|tojson }};
const statusShortcuts = [0, 1, 2, 3, 4, 5, 6];
const statusBoard = document.getElementById('dispatch-vehicle-board');
const statusError = document.getElementById('dispatch-status-error');
const unitSelect = form.querySelector('select[name="unit"]');
const statusSelect = form.querySelector('select[name="status"]');
const locationInput = form.querySelector('input[name="location"]');

function hideStatusError() {
  if (!statusError) return;
  statusError.classList.add('d-none');
  statusError.textContent = '';
}

function showStatusError(message) {
  if (!statusError) return;
  statusError.textContent = message;
  statusError.classList.remove('d-none');
}

function getStatusLabel(status) {
  const key = String(status);
  const label = statusText[key] || '';
  return `Status ${status} – ${label}`;
}

function formatDateTime(value) {
  if (!value) return '—';
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) return value;
  return date.toLocaleString('de-DE');
}

function updateVehiclesState(data) {
  Object.keys(vehiclesData).forEach(key => {
    if (!(key in data)) {
      delete vehiclesData[key];
    }
  });
  Object.entries(data).forEach(([key, value]) => {
    vehiclesData[key] = value;
  });
}

function updateAvailabilityData() {
  Object.keys(availableData).forEach(key => delete availableData[key]);
  Object.entries(vehiclesData).forEach(([unit, info]) => {
    const status = Number(info.status);
    const isAvailable = (status === 1 || status === 2) && !info.incident_id;
    availableData[unit] = isAvailable;
  });
}

function refreshUnitSelect() {
  const units = Object.keys(vehiclesData).sort((a, b) => a.localeCompare(b, 'de-DE', { numeric: true }));
  const current = unitSelect.value;
  unitSelect.innerHTML = '';
  units.forEach(unit => {
    const option = document.createElement('option');
    option.value = unit;
    option.textContent = unit;
    unitSelect.appendChild(option);
  });
  if (units.length) {
    unitSelect.value = units.includes(current) ? current : units[0];
  }
}

function updateDispatchCard(card, info) {
  const status = Number(info.status);
  card.dataset.status = status;
  const statusBadge = card.querySelector('.current-status .badge');
  if (statusBadge) {
    statusBadge.textContent = getStatusLabel(status);
  }
  const availabilityBadge = card.querySelector('.availability');
  if (availabilityBadge) {
    const isAvailable = (status === 1 || status === 2) && !info.incident_id;
    availabilityBadge.textContent = isAvailable ? 'Frei' : 'Gebunden';
    availabilityBadge.classList.toggle('bg-success', isAvailable);
    availabilityBadge.classList.toggle('bg-danger', !isAvailable);
    availabilityBadge.classList.toggle('bg-secondary', false);
  }
  const locationEl = card.querySelector('.dispatch-location');
  if (locationEl) {
    locationEl.textContent = info.location || '—';
  }
  const noteEl = card.querySelector('.dispatch-note');
  if (noteEl) {
    noteEl.textContent = info.note || '—';
  }
  const prioEl = card.querySelector('.dispatch-priority');
  if (prioEl) {
    prioEl.textContent = info.priority || '—';
  }
  const alarmEl = card.querySelector('.dispatch-alarm');
  if (alarmEl) {
    alarmEl.dataset.raw = info.alarm_time || '';
    alarmEl.textContent = formatDateTime(info.alarm_time);
  }
  const secondary = card.querySelector('.card-header small');
  if (secondary) {
    secondary.textContent = info.callsign || info.name || '';
  }
  card.classList.toggle('active-incident', Boolean(info.incident_id));
  card.querySelectorAll('.status-btn').forEach(btn => {
    const btnStatus = Number(btn.dataset.status);
    const isActive = btnStatus === status;
    btn.classList.toggle('btn-primary', isActive);
    btn.classList.toggle('btn-outline-secondary', !isActive);
  });
}

function createDispatchCard(unit, info) {
  const card = document.createElement('div');
  card.className = 'card status-card dispatch-card';
  card.dataset.unit = unit;
  card.innerHTML = `
    <div class="card-header d-flex justify-content-between align-items-start">
      <div>
        <h5 class="card-title mb-0">${unit}</h5>
        <small class="text-muted"></small>
      </div>
      <span class="availability badge rounded-pill"></span>
    </div>
    <div class="card-body">
      <p class="current-status mb-3">
        <span class="badge bg-primary"></span>
      </p>
      <div class="dispatch-meta mb-3">
        <span class="meta-label">Ort</span>
        <span class="meta-value dispatch-location"></span>
      </div>
      <div class="dispatch-meta mb-3">
        <span class="meta-label">Stichwort</span>
        <span class="meta-value dispatch-note"></span>
      </div>
      <div class="dispatch-meta mb-3">
        <span class="meta-label">Priorität</span>
        <span class="meta-value dispatch-priority"></span>
      </div>
      <div class="dispatch-meta mb-4">
        <span class="meta-label">Alarmiert</span>
        <span class="meta-value dispatch-alarm" data-raw=""></span>
      </div>
      <div class="d-flex status-buttons"></div>
    </div>
  `;
  const buttonsContainer = card.querySelector('.status-buttons');
  statusShortcuts.forEach(code => {
    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'btn btn-sm status-btn btn-outline-secondary';
    button.dataset.status = String(code);
    button.title = getStatusLabel(code);
    button.textContent = code;
    buttonsContainer.appendChild(button);
  });
  buttonsContainer.addEventListener('click', event => {
    const button = event.target.closest('.status-btn');
    if (!button || button.disabled) return;
    const targetStatus = Number(button.dataset.status);
    const buttons = Array.from(buttonsContainer.querySelectorAll('.status-btn'));
    buttons.forEach(btn => (btn.disabled = true));
    sendQuickStatus(unit, targetStatus)
      .catch(err => {
        showStatusError(err.message || 'Status konnte nicht gesetzt werden.');
      })
      .finally(() => {
        if (!document.body.contains(buttonsContainer)) return;
        buttons.forEach(btn => (btn.disabled = false));
      });
  });
  updateDispatchCard(card, info);
  return card;
}

function renderVehicleBoard() {
  if (!statusBoard) return;
  const units = Object.keys(vehiclesData).sort((a, b) => a.localeCompare(b, 'de-DE', { numeric: true }));
  statusBoard.innerHTML = '';
  units.forEach(unit => {
    const info = vehiclesData[unit];
    if (!info) return;
    const card = createDispatchCard(unit, info);
    statusBoard.appendChild(card);
  });
}

async function refreshVehicles() {
  try {
    const response = await fetch('/api/status', {
      cache: 'no-store',
      headers: {
        'Cache-Control': 'no-store'
      }
    });
    if (!response.ok) throw new Error('Fahrzeugdaten konnten nicht geladen werden.');
    const data = await response.json();
    updateVehiclesState(data);
    updateAvailabilityData();
    renderVehicleBoard();
    refreshUnitSelect();
    updateStatusSelect();
    hideStatusError();
  } catch (err) {
    showStatusError(err.message || 'Fahrzeugdaten konnten nicht geladen werden.');
    throw err;
  }
}

async function sendQuickStatus(unit, status) {
  hideStatusError();
  const response = await fetch('/api/dispatch', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ unit, status })
  });
  const data = await response.json().catch(() => ({}));
  if (!response.ok || !data.ok) {
    throw new Error('Status konnte nicht gesetzt werden.');
  }
  await refreshVehicles();
}

renderVehicleBoard();
updateAvailabilityData();
refreshUnitSelect();
function updateStatusSelect() {
    const unit = unitSelect.value;
    if (vehiclesData[unit]) {
        statusSelect.value = vehiclesData[unit].status;
        locationInput.value = vehiclesData[unit].location || '';
    }
}
unitSelect.addEventListener('change', updateStatusSelect);
updateStatusSelect();
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const payload = Object.fromEntries(formData.entries());
    if (!payload.location) delete payload.location;
    try {
        const res = await fetch('/api/dispatch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        const resultEl = document.getElementById('result');
        resultEl.textContent = data.ok ? 'Gesendet' : 'Fehler';
        if (data.ok) {
            try {
                await refreshVehicles();
            } catch (err) {
                console.error(err);
            }
        }
    } catch (err) {
        document.getElementById('result').textContent = 'Fehler';
    }
});

const incidentModal = new bootstrap.Modal(document.getElementById('incident-modal'));
const incidentError = document.getElementById('incident-error');
const incidentModalEl = document.getElementById('incident-modal');
incidentModalEl.addEventListener('show.bs.modal', () => {
  incidentError.classList.add('d-none');
  incidentError.textContent = '';
});

let autoReloadPauseCount = 0;
let reloadPending = false;

function pauseAutoReload() {
  autoReloadPauseCount += 1;
}

function resumeAutoReload(triggerReload = false, options = {}) {
  const { clearPending = false } = options;
  if (autoReloadPauseCount > 0) {
    autoReloadPauseCount -= 1;
  }
  if (autoReloadPauseCount > 0) {
    if (triggerReload) reloadPending = true;
    return;
  }
  if (triggerReload) {
    reloadPending = false;
    window.location.reload();
    return;
  }
  if (clearPending) {
    reloadPending = false;
    return;
  }
  if (reloadPending) {
    reloadPending = false;
    window.location.reload();
  }
}

function fillIncidentModal(inc) {
  const f = document.getElementById('incident-form');
  f.reset();
  f.elements['id'].value = inc.id || '';
  f.start.value = inc.start ? new Date(inc.start).toLocaleString('de-DE') : '';
  f.keyword.value = inc.keyword || '';
  f.location.value = (inc.location && inc.location.name) || '';
  f.priority.value = inc.priority || '';
  f.patient.value = inc.patient || '';
  f.note.value = '';
  f.template.value = '';
  f.querySelectorAll('input[name="vehicles"]').forEach(cb => {
    cb.checked = inc.vehicles && inc.vehicles.includes(cb.value);
    cb.disabled = !availableData[cb.value] && !cb.checked;
  });
  f.querySelectorAll('.alarm-check').forEach(cb => {
    const unit = cb.dataset.unit;
    cb.checked = vehiclesData[unit] && vehiclesData[unit].alarm_time;
  });
  document.querySelector('#incident-modal .modal-title').textContent = inc.id ? 'Einsatz bearbeiten' : 'Einsatz anlegen';
}
document.getElementById('incident-new').addEventListener('click', () => {
  fillIncidentModal({});
  incidentModal.show();
});
document.querySelectorAll('#incident-list .edit').forEach(btn => {
  btn.addEventListener('click', async e => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    const res = await fetch(`/api/incidents/${id}`);
    const inc = await res.json();
    fillIncidentModal(inc);
    incidentModal.show();
  });
});

document.getElementById('incident-save').addEventListener('click', async () => {
  const f = document.getElementById('incident-form');
  const id = f.elements['id'].value;
  const payload = {
    keyword: f.keyword.value,
    location: f.location.value,
    priority: f.priority.value,
    patient: f.patient.value
  };
  const units = Array.from(f.querySelectorAll('input[name="vehicles"]:checked')).map(cb => cb.value);
  if (units.length) payload.vehicles = units;
  const note = f.note.value.trim();
  if (note) payload.note = note;
  const url = id ? `/api/incidents/${id}` : '/api/incidents';
  const method = id ? 'PUT' : 'POST';
  pauseAutoReload();
  let success = false;
  try {
    const res = await fetch(url, {
      method,
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    const r = await res.json();
    if (r.ok) {
      success = true;
      incidentModal.hide();
      try {
        await refreshVehicles();
      } catch (err) {
        console.error(err);
      }
    }
  } catch (err) {
    console.error(err);
  } finally {
    resumeAutoReload(success, { clearPending: !success });
  }
});

// Handle the "Alarmieren" button inside the incident modal
// This creates or updates the incident and then alerts all selected vehicles
document.getElementById('incident-alert').addEventListener('click', async () => {
  const f = document.getElementById('incident-form');
  const alertBtn = document.getElementById('incident-alert');
  let id = f.elements['id'].value; // Existing incident id (empty when creating)
  const units = Array.from(f.querySelectorAll('input[name="vehicles"]:checked')).map(cb => cb.value);

  // Gather incident details from the form
  const details = {
    keyword: f.keyword.value,
    location: f.location.value,
    priority: f.priority.value,
    patient: f.patient.value,
    vehicles: units
  };
  const note = f.note.value.trim();
  if (note) details.note = note;

  if (!units.length) {
    incidentError.textContent = 'Bitte mindestens ein Fahrzeug auswählen.';
    incidentError.classList.remove('d-none');
    return;
  }

  // Update an existing incident or create a new one if no id is present
  incidentError.classList.add('d-none');
  incidentError.textContent = '';
  alertBtn.disabled = true;
  pauseAutoReload();
  let success = false;
  try {
    if (id) {
      const updateRes = await fetch(`/api/incidents/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(details)
      });
      if (!updateRes.ok) {
        throw new Error('update');
      }
    } else {
      const res = await fetch('/api/incidents', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(details)
      });
      const r = await res.json().catch(() => ({}));
      if (!res.ok || !r.ok) {
        throw new Error('create');
      }
      id = r.id;
      f.elements['id'].value = id;
    }

    const alertRes = await fetch(`/api/incidents/${id}/alert`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({units})
    });
    const alertData = await alertRes.json().catch(() => ({}));
    if (!alertRes.ok || !alertData.ok) {
      throw new Error('alert');
    }
    success = true;
    incidentModal.hide();
    try {
      await refreshVehicles();
    } catch (err) {
      console.error(err);
    }
  } catch (err) {
    console.error(err);
    let message = 'Alarmierung fehlgeschlagen. Bitte erneut versuchen.';
    if (err instanceof Error) {
      if (err.message === 'update') {
        message = 'Einsatz konnte nicht aktualisiert werden.';
      } else if (err.message === 'create') {
        message = 'Einsatz konnte nicht angelegt werden.';
      }
    }
    incidentError.textContent = message;
    incidentError.classList.remove('d-none');
    alertBtn.disabled = false;
  } finally {
    resumeAutoReload(success, { clearPending: !success });
  }
  if (success) {
    // ensure the button is re-enabled for future interactions after reload
    alertBtn.disabled = false;
  }
});

const templateList = {{ templates|tojson }};
const templateMap = {};
templateList.forEach(t => { templateMap[t.id] = t; });
document.querySelector('#incident-form [name="template"]').addEventListener('change', (e) => {
  const f = document.getElementById('incident-form');
  const t = templateMap[e.target.value];
  if (t) {
    f.keyword.value = t.keyword || '';
    f.priority.value = t.priority || '';
  }
});
document.querySelectorAll('#incident-list .end').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    pauseAutoReload();
    try {
      const res = await fetch(`/api/incidents/${id}/end`, {method: 'POST'});
      const r = await res.json();
      if (r.ok) {
        try {
          await refreshVehicles();
        } catch (err) {
          console.error(err);
        }
      }
      resumeAutoReload(r.ok, { clearPending: !r.ok });
    } catch (err) {
      console.error(err);
      resumeAutoReload(false, { clearPending: true });
    }
  });
});

document.querySelectorAll('#incident-list .delete').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    pauseAutoReload();
    try {
      const res = await fetch(`/api/incidents/${id}`, {method: 'DELETE'});
      const r = await res.json();
      resumeAutoReload(r.ok, { clearPending: !r.ok });
    } catch (err) {
      console.error(err);
      resumeAutoReload(false, { clearPending: true });
    }
  });
});

const evtSource = new EventSource('/events');
evtSource.onmessage = () => {
  if (autoReloadPauseCount > 0) {
    reloadPending = true;
    return;
  }
  window.location.reload();
};
</script>
{% endblock %}
