{% extends 'base.html' %}
{% block content %}
<div class="dispatch-toolbar mb-4">
  <div>
    <h1 class="mb-1">Leitstellen Interface</h1>
    <p class="mb-0 text-white-50">Zentrale Übersicht und Einsatzsteuerung</p>
  </div>
  <div class="d-flex flex-wrap gap-2">
    <button class="btn btn-danger btn-lg shadow" id="incident-new">Neuen Einsatz anlegen</button>
  </div>
</div>

<div class="alert alert-danger d-none" role="alert" id="dispatch-status-error"></div>

<div class="vehicle-board-header mt-5 d-flex justify-content-between align-items-center">
  <h2 class="mb-0">Fahrzeugübersicht</h2>
  <button type="button" class="btn btn-outline-light btn-sm" id="vehicle-board-toggle" aria-expanded="true">
    Übersicht einklappen
  </button>
</div>
<div id="vehicle-board-container" class="vehicle-board-container">
<div id="dispatch-vehicle-board" class="status-grid">
  {% for name, info in vehicles.items() %}
  <div class="card status-card dispatch-card" data-unit="{{ name }}">
    <div class="card-header d-flex justify-content-between align-items-start">
      <div>
        <h5 class="card-title mb-0">{{ name }}</h5>
        <small class="dispatch-callsign d-block">{{ info.callsign or info.name }}</small>
      </div>
      <span class="availability badge rounded-pill"></span>
    </div>
    <div class="card-body">
      <p class="current-status mb-3">
        <span class="badge bg-primary">Status {{ info.status }} – {{ status_text[info.status] }}</span>
      </p>
      <div class="dispatch-meta mb-3">
        <span class="meta-label">Ort</span>
        <span class="meta-value dispatch-location">{{ info.location or '—' }}</span>
      </div>
      <div class="dispatch-meta mb-3">
        <span class="meta-label">Stichwort</span>
        <span class="meta-value dispatch-note">{{ info.note or '—' }}</span>
      </div>
      <div class="dispatch-meta mb-3">
        <span class="meta-label">Priorität</span>
        <span class="meta-value dispatch-priority">{{ info.priority or '—' }}</span>
      </div>
      <div class="dispatch-meta mb-4">
        <span class="meta-label">Alarmiert</span>
        <span class="meta-value dispatch-alarm" data-raw="{{ info.alarm_time or '' }}">{{ info.alarm_time or '—' }}</span>
      </div>
      <div class="mb-3">
        <label class="form-label form-label-sm text-uppercase fw-semibold text-white-50" for="status-select-{{ loop.index }}">Status ändern</label>
        <select class="form-select form-select-sm status-select" id="status-select-{{ loop.index }}" data-unit="{{ name }}">
          {% for code, text in status_text|dictsort %}
          <option value="{{ code }}" {% if code == info.status %}selected{% endif %}>{{ code }} – {{ text }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="d-flex status-buttons">
        {% for code in [0, 1, 2, 3, 4, 5, 6] %}
        <button type="button" class="btn btn-sm status-btn {% if code == info.status %}btn-primary{% else %}btn-outline-secondary{% endif %}" data-status="{{ code }}" title="Status {{ code }} – {{ status_text[code] }}">
          {{ code }}
        </button>
        {% endfor %}
      </div>
      <div class="incident-actions d-flex align-items-center justify-content-between mt-4">
        <span class="incident-tag badge bg-danger-subtle text-danger-emphasis {% if not info.incident_id %}d-none{% endif %}">Einsatz #{{ info.incident_id }}</span>
        <button type="button" class="btn btn-warning btn-sm incident-jump {% if not info.incident_id %}d-none{% endif %}" data-incident-id="{{ info.incident_id or '' }}">
          Einsatz bearbeiten
        </button>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
</div>
<div class="d-flex justify-content-between align-items-center mt-5 mb-3">
  <h2 class="mb-0">Einsätze</h2>
  <span class="text-white-50 small">Gesamt: {{ incidents|length }}</span>
</div>
<div class="dispatch-panel shadow-sm">
  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle mb-0" id="incident-list">
      <thead>
        <tr><th>ID</th><th>Start</th><th>Fahrzeuge</th><th>Ort</th><th>Stichwort</th><th>Aktiv</th><th>Notizen</th><th>Protokoll</th><th>Aktion</th></tr>
      </thead>
      <tbody>
      {% for inc in incidents %}
        <tr data-id="{{ inc.id }}">
          <td>{{ inc.id }}</td>
          <td>{{ inc.start }}</td>
          <td>{{ inc.vehicles|join(', ') }}</td>
          <td>{{ inc.location.name }}</td>
          <td>{{ inc.keyword }}</td>
          <td>{{ 'Ja' if inc.active else 'Nein' }}</td>
          <td>
            <ul class="list-unstyled mb-0">
              {% for n in inc.notes %}
              <li>{{ n.time }} - {{ n.text }}</li>
              {% endfor %}
            </ul>
          </td>
          <td>
            <ul class="list-unstyled mb-0">
              {% for l in inc.log or [] %}
              <li>{{ l.time }} - {{ l.unit }}: {{ l.status if l.status is string else l.status ~ ' - ' ~ status_text[l.status] }}</li>
              {% endfor %}
            </ul>
          </td>
          <td class="incident-actions-col">
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-light edit">Bearbeiten</button>
              {% if inc.active %}
              <button class="btn btn-outline-success end">Beenden</button>
              {% endif %}
              <button class="btn btn-outline-danger delete">Löschen</button>
            </div>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Incident detail modal -->
<div class="modal fade" id="incident-modal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content incident-modal">
      <div class="modal-header border-0 pb-0">
        <div>
          <p class="modal-subtitle text-uppercase text-white-50 mb-1">Einsatzverwaltung</p>
          <h5 class="modal-title mb-0">Einsatz</h5>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="incident-form" class="incident-form">
          <input type="hidden" name="id">
          <div class="incident-section">
            <div class="section-header">
              <span class="section-title">Stammdaten</span>
              <span class="section-meta" id="incident-start-display">&nbsp;</span>
            </div>
            <div class="row g-3 align-items-end">
              <div class="col-md-4">
                <label class="form-label" for="incident-template">Vorlage</label>
                <select name="template" id="incident-template" class="form-select">
                  <option value="">--</option>
                  {% for t in templates %}
                  <option value="{{ t.id }}">{{ t.label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label" for="incident-keyword">Stichwort</label>
                <input type="text" name="keyword" id="incident-keyword" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label" for="incident-priority">Priorität</label>
                <select name="priority" id="incident-priority" class="form-select">
                  <option value="">--</option>
                  {% for prio in priority_options %}
                  <option value="{{ prio }}">{{ prio }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>

          <div class="incident-section">
            <div class="section-header">
              <span class="section-title">Einsatzort &amp; Patient</span>
            </div>
            <div class="row g-3">
              <div class="col-md-8">
                <label class="form-label" for="incident-location">Ort / Adresse</label>
                <input type="text" name="location" id="incident-location" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label" for="incident-patient">Patient</label>
                <input type="text" name="patient" id="incident-patient" class="form-control">
              </div>
            </div>
          </div>

          <div class="incident-section">
            <div class="section-header">
              <span class="section-title">Fahrzeugzuordnung</span>
              <span class="section-meta">Alarmstatus wird automatisch angezeigt</span>
            </div>
            <div class="incident-vehicle-grid">
            {% for name, info in vehicles.items() %}
              <label class="incident-vehicle-option" for="iv{{ loop.index }}">
                <input class="form-check-input me-2" type="checkbox" name="vehicles" value="{{ name }}" id="iv{{ loop.index }}">
                <span class="vehicle-label-text">{{ name }}</span>
                <span class="alarm-indicator" data-unit="{{ name }}" title="Alarmiert"></span>
              </label>
            {% endfor %}
            </div>
          </div>

          <div class="incident-section">
            <div class="section-header">
              <span class="section-title">Notizen</span>
            </div>
            <textarea name="note" id="incident-note" class="form-control" rows="3" placeholder="Zusätzliche Informationen oder Einsatznotizen"></textarea>
          </div>
        </form>
        <div class="alert alert-danger d-none" role="alert" id="incident-error"></div>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Schließen</button>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-secondary" id="incident-save">Speichern</button>
          <button type="button" class="btn btn-success d-none" id="incident-end">Einsatz beenden</button>
          <button type="button" class="btn btn-danger" id="incident-alert">Alarmieren</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
const vehiclesData = {{ vehicles|tojson }};
const availableData = {{ available|tojson }};
const statusText = {{ status_text|tojson }};
const statusShortcuts = [0, 1, 2, 3, 4, 5, 6];
const statusBoard = document.getElementById('dispatch-vehicle-board');
const statusError = document.getElementById('dispatch-status-error');
const boardContainer = document.getElementById('vehicle-board-container');
const boardToggle = document.getElementById('vehicle-board-toggle');
const incidentToolbarButton = document.getElementById('incident-new');

function normalizeStatusValue(value) {
  if (value === null || value === undefined) return value;
  const stringValue = String(value);
  return /^\d+$/.test(stringValue) ? Number(stringValue) : stringValue;
}

function hideStatusError() {
  if (!statusError) return;
  statusError.classList.add('d-none');
  statusError.textContent = '';
}

function showStatusError(message) {
  if (!statusError) return;
  statusError.textContent = message;
  statusError.classList.remove('d-none');
}

function getStatusLabel(status) {
  const key = String(status);
  const label = statusText[key] || '';
  return `Status ${status} – ${label}`;
}

function formatDateTime(value) {
  if (!value) return '—';
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) return value;
  return date.toLocaleString('de-DE');
}

function updateVehiclesState(data) {
  Object.keys(vehiclesData).forEach(key => {
    if (!(key in data)) {
      delete vehiclesData[key];
    }
  });
  Object.entries(data).forEach(([key, value]) => {
    vehiclesData[key] = value;
  });
}

function updateAvailabilityData() {
  Object.keys(availableData).forEach(key => delete availableData[key]);
  Object.entries(vehiclesData).forEach(([unit, info]) => {
    const status = Number(info.status);
    const isAvailable = (status === 1 || status === 2) && !info.incident_id;
    availableData[unit] = isAvailable;
  });
}

function updateDispatchCard(card, info) {
  const status = Number(info.status);
  card.dataset.status = status;
  card.dataset.incidentId = info.incident_id || '';
  const statusBadge = card.querySelector('.current-status .badge');
  if (statusBadge) {
    statusBadge.textContent = getStatusLabel(status);
  }
  const statusSelectEl = card.querySelector('.status-select');
  if (statusSelectEl) {
    statusSelectEl.value = String(info.status);
  }
  const availabilityBadge = card.querySelector('.availability');
  if (availabilityBadge) {
    const isAvailable = (status === 1 || status === 2) && !info.incident_id;
    availabilityBadge.textContent = isAvailable ? 'Frei' : 'Gebunden';
    availabilityBadge.classList.toggle('bg-success', isAvailable);
    availabilityBadge.classList.toggle('bg-danger', !isAvailable);
    availabilityBadge.classList.toggle('bg-secondary', false);
  }
  const locationEl = card.querySelector('.dispatch-location');
  if (locationEl) {
    locationEl.textContent = info.location || '—';
  }
  const noteEl = card.querySelector('.dispatch-note');
  if (noteEl) {
    noteEl.textContent = info.note || '—';
  }
  const prioEl = card.querySelector('.dispatch-priority');
  if (prioEl) {
    prioEl.textContent = info.priority || '—';
  }
  const alarmEl = card.querySelector('.dispatch-alarm');
  if (alarmEl) {
    alarmEl.dataset.raw = info.alarm_time || '';
    alarmEl.textContent = formatDateTime(info.alarm_time);
  }
  const secondary = card.querySelector('.card-header small');
  if (secondary) {
    secondary.textContent = info.callsign || info.name || '';
  }
  const incidentTag = card.querySelector('.incident-tag');
  const incidentBtn = card.querySelector('.incident-jump');
  const hasIncident = Boolean(info.incident_id);
  if (incidentTag) {
    incidentTag.classList.toggle('d-none', !hasIncident);
    incidentTag.textContent = hasIncident ? `Einsatz #${info.incident_id}` : '';
  }
  if (incidentBtn) {
    incidentBtn.classList.toggle('d-none', !hasIncident);
    incidentBtn.dataset.incidentId = hasIncident ? info.incident_id : '';
    if (hasIncident) {
      incidentBtn.textContent = `Einsatz #${info.incident_id} bearbeiten`;
    }
  }
  card.classList.toggle('active-incident', Boolean(info.incident_id));
  card.querySelectorAll('.status-btn').forEach(btn => {
    const btnStatus = Number(btn.dataset.status);
    const isActive = btnStatus === status;
    btn.classList.toggle('btn-primary', isActive);
    btn.classList.toggle('btn-outline-secondary', !isActive);
  });
}

function createDispatchCard(unit, info) {
  const card = document.createElement('div');
  card.className = 'card status-card dispatch-card';
  card.dataset.unit = unit;
  const statusOptions = Object.keys(statusText)
    .sort((a, b) => a.localeCompare(b, 'de-DE', { numeric: true }))
    .map(code => `<option value="${code}">${code} – ${statusText[code]}</option>`)
    .join('');
  card.innerHTML = `
    <div class="card-header d-flex justify-content-between align-items-start">
      <div>
        <h5 class="card-title mb-0">${unit}</h5>
        <small class="dispatch-callsign d-block"></small>
      </div>
      <span class="availability badge rounded-pill"></span>
    </div>
    <div class="card-body">
      <p class="current-status mb-3">
        <span class="badge bg-primary"></span>
      </p>
      <div class="dispatch-meta mb-3">
        <span class="meta-label">Ort</span>
        <span class="meta-value dispatch-location"></span>
      </div>
      <div class="dispatch-meta mb-3">
        <span class="meta-label">Stichwort</span>
        <span class="meta-value dispatch-note"></span>
      </div>
      <div class="dispatch-meta mb-3">
        <span class="meta-label">Priorität</span>
        <span class="meta-value dispatch-priority"></span>
      </div>
      <div class="dispatch-meta mb-4">
        <span class="meta-label">Alarmiert</span>
        <span class="meta-value dispatch-alarm" data-raw=""></span>
      </div>
      <div class="mb-3">
        <label class="form-label form-label-sm text-uppercase fw-semibold text-white-50">Status ändern</label>
        <select class="form-select form-select-sm status-select" data-unit="${unit}">
          ${statusOptions}
        </select>
      </div>
      <div class="d-flex status-buttons"></div>
      <div class="incident-actions d-flex align-items-center justify-content-between mt-4">
        <span class="incident-tag badge bg-danger-subtle text-danger-emphasis d-none"></span>
        <button type="button" class="btn btn-warning btn-sm incident-jump d-none" data-incident-id="">
          Einsatz bearbeiten
        </button>
      </div>
    </div>
  `;
  const buttonsContainer = card.querySelector('.status-buttons');
  statusShortcuts.forEach(code => {
    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'btn btn-sm status-btn btn-outline-secondary';
    button.dataset.status = String(code);
    button.title = getStatusLabel(code);
    button.textContent = code;
    buttonsContainer.appendChild(button);
  });
  buttonsContainer.addEventListener('click', event => {
    const button = event.target.closest('.status-btn');
    if (!button || button.disabled) return;
    const targetStatus = Number(button.dataset.status);
    const buttons = Array.from(buttonsContainer.querySelectorAll('.status-btn'));
    buttons.forEach(btn => (btn.disabled = true));
    sendQuickStatus(unit, targetStatus)
      .catch(err => {
        showStatusError(err.message || 'Status konnte nicht gesetzt werden.');
      })
      .finally(() => {
        if (!document.body.contains(buttonsContainer)) return;
        buttons.forEach(btn => (btn.disabled = false));
      });
  });
  const selectEl = card.querySelector('.status-select');
  attachStatusSelect(selectEl, unit);
  updateDispatchCard(card, info);
  return card;
}

function renderVehicleBoard() {
  if (!statusBoard) return;
  const units = Object.keys(vehiclesData).sort((a, b) => a.localeCompare(b, 'de-DE', { numeric: true }));
  statusBoard.innerHTML = '';
  units.forEach(unit => {
    const info = vehiclesData[unit];
    if (!info) return;
    const card = createDispatchCard(unit, info);
    statusBoard.appendChild(card);
  });
}

async function refreshVehicles() {
  try {
    const response = await fetch('/api/status', {
      cache: 'no-store',
      headers: {
        'Cache-Control': 'no-store'
      }
    });
    if (!response.ok) throw new Error('Fahrzeugdaten konnten nicht geladen werden.');
    const data = await response.json();
    updateVehiclesState(data);
    updateAvailabilityData();
    renderVehicleBoard();
    setupStatusSelects(statusBoard);
    setupIncidentButtons(statusBoard);
    hideStatusError();
  } catch (err) {
    showStatusError(err.message || 'Fahrzeugdaten konnten nicht geladen werden.');
    throw err;
  }
}

async function sendQuickStatus(unit, status) {
  hideStatusError();
  const response = await fetch('/api/dispatch', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ unit, status: normalizeStatusValue(status) })
  });
  const data = await response.json().catch(() => ({}));
  if (!response.ok || !data.ok) {
    throw new Error('Status konnte nicht gesetzt werden.');
  }
  await refreshVehicles();
}

function attachStatusSelect(select, unit) {
  if (!select) return;
  if (select.dataset.hasHandler === 'true') return;
  select.dataset.hasHandler = 'true';
  select.addEventListener('change', async event => {
    const target = event.target;
    const newStatus = target.value;
    const previous = vehiclesData[unit] ? String(vehiclesData[unit].status) : '';
    target.disabled = true;
    try {
      await sendQuickStatus(unit, newStatus);
    } catch (err) {
      showStatusError(err.message || 'Status konnte nicht gesetzt werden.');
      target.value = previous;
    } finally {
      target.disabled = false;
    }
  });
}

function setupStatusSelects(scope = document) {
  if (!scope) return;
  scope.querySelectorAll('.status-select').forEach(select => {
    const card = select.closest('.dispatch-card');
    const unit = card ? card.dataset.unit : select.dataset.unit;
    if (!unit) return;
    attachStatusSelect(select, unit);
  });
}

function setupIncidentButtons(scope = document) {
  if (!scope) return;
  scope.querySelectorAll('.incident-jump').forEach(button => {
    if (button.dataset.hasHandler === 'true') return;
    button.dataset.hasHandler = 'true';
    button.addEventListener('click', event => {
      event.preventDefault();
      event.stopPropagation();
      const incidentId = button.dataset.incidentId;
      if (!incidentId) return;
      openIncidentEditor(incidentId);
    });
  });
}

function setBoardCollapsed(collapsed) {
  if (!boardContainer || !boardToggle) return;
  boardContainer.classList.toggle('collapsed', collapsed);
  boardToggle.setAttribute('aria-expanded', String(!collapsed));
  boardToggle.textContent = collapsed ? 'Übersicht einblenden' : 'Übersicht einklappen';
}

if (boardToggle) {
  boardToggle.addEventListener('click', () => {
    const isCollapsed = boardContainer?.classList.contains('collapsed');
    setBoardCollapsed(!isCollapsed);
  });
}

renderVehicleBoard();
updateAvailabilityData();
setupStatusSelects(statusBoard);
setupIncidentButtons(statusBoard);

const incidentModal = new bootstrap.Modal(document.getElementById('incident-modal'));
const incidentError = document.getElementById('incident-error');
const incidentModalEl = document.getElementById('incident-modal');
const incidentEndBtn = document.getElementById('incident-end');
incidentModalEl.addEventListener('show.bs.modal', () => {
  incidentError.classList.add('d-none');
  incidentError.textContent = '';
  if (incidentEndBtn) {
    incidentEndBtn.disabled = false;
  }
});
incidentModalEl.addEventListener('shown.bs.modal', () => {
  const focusTarget = incidentModalEl.querySelector('#incident-keyword');
  if (focusTarget) {
    focusTarget.focus();
  }
});

let autoReloadPauseCount = 0;
let reloadPending = false;

function pauseAutoReload() {
  autoReloadPauseCount += 1;
}

function resumeAutoReload(triggerReload = false, options = {}) {
  const { clearPending = false } = options;
  if (autoReloadPauseCount > 0) {
    autoReloadPauseCount -= 1;
  }
  if (autoReloadPauseCount > 0) {
    if (triggerReload) reloadPending = true;
    return;
  }
  if (triggerReload) {
    reloadPending = false;
    window.location.reload();
    return;
  }
  if (clearPending) {
    reloadPending = false;
    return;
  }
  if (reloadPending) {
    reloadPending = false;
    window.location.reload();
  }
}

function fillIncidentModal(inc) {
  const f = document.getElementById('incident-form');
  f.reset();
  f.elements['id'].value = inc.id || '';
  const startDisplay = document.getElementById('incident-start-display');
  if (startDisplay) {
    const text = inc.start ? new Date(inc.start).toLocaleString('de-DE') : 'Keine Startzeit erfasst';
    startDisplay.textContent = text;
  }
  f.keyword.value = inc.keyword || '';
  f.location.value = (inc.location && inc.location.name) || '';
  f.priority.value = inc.priority || '';
  f.patient.value = inc.patient || '';
  f.note.value = '';
  f.template.value = inc.template || '';
  f.querySelectorAll('input[name="vehicles"]').forEach(cb => {
    const unit = cb.value;
    const isSelected = inc.vehicles && inc.vehicles.includes(unit);
    const isAvailable = availableData[unit];
    cb.checked = isSelected;
    cb.disabled = !isAvailable && !isSelected;
    const option = cb.closest('.incident-vehicle-option');
    if (option) {
      option.classList.toggle('disabled', cb.disabled && !isSelected);
      option.classList.toggle('selected', isSelected);
    }
  });
  f.querySelectorAll('.alarm-indicator').forEach(span => {
    const unit = span.dataset.unit;
    const isAlarmed = Boolean(vehiclesData[unit] && vehiclesData[unit].alarm_time);
    span.classList.toggle('active', isAlarmed);
    span.textContent = isAlarmed ? 'Alarmiert' : 'Bereit';
  });
  const modalTitle = document.querySelector('#incident-modal .modal-title');
  if (modalTitle) {
    modalTitle.textContent = inc.id ? `Einsatz #${inc.id}` : 'Neuer Einsatz';
  }
  if (incidentEndBtn) {
    const canEnd = Boolean(inc.id && inc.active);
    incidentEndBtn.classList.toggle('d-none', !canEnd);
    incidentEndBtn.dataset.incidentId = canEnd ? inc.id : '';
    incidentEndBtn.disabled = !canEnd;
  }
}
async function fetchIncident(id) {
  const response = await fetch(`/api/incidents/${id}`);
  if (!response.ok) {
    throw new Error('Einsatz konnte nicht geladen werden.');
  }
  return response.json();
}

async function openIncidentEditor(id) {
  try {
    const inc = await fetchIncident(id);
    fillIncidentModal(inc);
    incidentModal.show();
  } catch (err) {
    console.error(err);
    showStatusError(err.message || 'Einsatz konnte nicht geladen werden.');
  }
}

if (incidentToolbarButton) {
  incidentToolbarButton.addEventListener('click', () => {
    fillIncidentModal({});
    incidentModal.show();
  });
}
document.querySelectorAll('#incident-list .edit').forEach(btn => {
  btn.addEventListener('click', async e => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    openIncidentEditor(id);
  });
});

const incidentFormEl = document.getElementById('incident-form');
if (incidentFormEl) {
  incidentFormEl.addEventListener('change', event => {
    const checkbox = event.target.closest('input[name="vehicles"]');
    if (!checkbox) return;
    const option = checkbox.closest('.incident-vehicle-option');
    if (!option) return;
    option.classList.toggle('selected', checkbox.checked);
  });
}

document.getElementById('incident-save').addEventListener('click', async () => {
  const f = document.getElementById('incident-form');
  const id = f.elements['id'].value;
  const payload = {
    keyword: f.keyword.value,
    location: f.location.value,
    priority: f.priority.value,
    patient: f.patient.value
  };
  const units = Array.from(f.querySelectorAll('input[name="vehicles"]:checked')).map(cb => cb.value);
  if (units.length) payload.vehicles = units;
  const note = f.note.value.trim();
  if (note) payload.note = note;
  const url = id ? `/api/incidents/${id}` : '/api/incidents';
  const method = id ? 'PUT' : 'POST';
  pauseAutoReload();
  let success = false;
  try {
    const res = await fetch(url, {
      method,
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    const r = await res.json();
    if (r.ok) {
      success = true;
      incidentModal.hide();
      try {
        await refreshVehicles();
      } catch (err) {
        console.error(err);
      }
    }
  } catch (err) {
    console.error(err);
  } finally {
    resumeAutoReload(success, { clearPending: !success });
  }
});

if (incidentEndBtn) {
  incidentEndBtn.addEventListener('click', async () => {
    const incidentId = Number(incidentEndBtn.dataset.incidentId || incidentEndBtn.dataset.incidentid);
    if (!incidentId) {
      return;
    }
    incidentError.classList.add('d-none');
    incidentError.textContent = '';
    incidentEndBtn.disabled = true;
    pauseAutoReload();
    let success = false;
    try {
      const response = await fetch(`/api/incidents/${incidentId}/end`, { method: 'POST' });
      const data = await response.json().catch(() => ({}));
      if (!response.ok || !data.ok) {
        throw new Error('Einsatz konnte nicht beendet werden.');
      }
      success = true;
      incidentModal.hide();
      try {
        await refreshVehicles();
      } catch (err) {
        console.error(err);
      }
    } catch (err) {
      const message = err?.message || 'Einsatz konnte nicht beendet werden.';
      incidentError.textContent = message;
      incidentError.classList.remove('d-none');
    } finally {
      resumeAutoReload(success, { clearPending: !success });
      incidentEndBtn.disabled = false;
    }
  });
}

// Handle the "Alarmieren" button inside the incident modal
// This creates or updates the incident and then alerts all selected vehicles
document.getElementById('incident-alert').addEventListener('click', async () => {
  const f = document.getElementById('incident-form');
  const alertBtn = document.getElementById('incident-alert');
  let id = f.elements['id'].value; // Existing incident id (empty when creating)
  const units = Array.from(f.querySelectorAll('input[name="vehicles"]:checked')).map(cb => cb.value);

  // Gather incident details from the form
  const details = {
    keyword: f.keyword.value,
    location: f.location.value,
    priority: f.priority.value,
    patient: f.patient.value,
    vehicles: units
  };
  const note = f.note.value.trim();
  if (note) details.note = note;

  if (!units.length) {
    incidentError.textContent = 'Bitte mindestens ein Fahrzeug auswählen.';
    incidentError.classList.remove('d-none');
    return;
  }

  // Update an existing incident or create a new one if no id is present
  incidentError.classList.add('d-none');
  incidentError.textContent = '';
  alertBtn.disabled = true;
  pauseAutoReload();
  let success = false;
  try {
    if (id) {
      const updateRes = await fetch(`/api/incidents/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(details)
      });
      if (!updateRes.ok) {
        throw new Error('update');
      }
    } else {
      const res = await fetch('/api/incidents', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(details)
      });
      const r = await res.json().catch(() => ({}));
      if (!res.ok || !r.ok) {
        throw new Error('create');
      }
      id = r.id;
      f.elements['id'].value = id;
    }

    const alertRes = await fetch(`/api/incidents/${id}/alert`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({units})
    });
    const alertData = await alertRes.json().catch(() => ({}));
    if (!alertRes.ok || !alertData.ok) {
      throw new Error('alert');
    }
    success = true;
    incidentModal.hide();
    try {
      await refreshVehicles();
    } catch (err) {
      console.error(err);
    }
  } catch (err) {
    console.error(err);
    let message = 'Alarmierung fehlgeschlagen. Bitte erneut versuchen.';
    if (err instanceof Error) {
      if (err.message === 'update') {
        message = 'Einsatz konnte nicht aktualisiert werden.';
      } else if (err.message === 'create') {
        message = 'Einsatz konnte nicht angelegt werden.';
      }
    }
    incidentError.textContent = message;
    incidentError.classList.remove('d-none');
    alertBtn.disabled = false;
  } finally {
    resumeAutoReload(success, { clearPending: !success });
  }
  if (success) {
    // ensure the button is re-enabled for future interactions after reload
    alertBtn.disabled = false;
  }
});

const templateList = {{ templates|tojson }};
const templateMap = {};
templateList.forEach(t => { templateMap[t.id] = t; });
document.querySelector('#incident-form [name="template"]').addEventListener('change', (e) => {
  const f = document.getElementById('incident-form');
  const t = templateMap[e.target.value];
  if (t) {
    f.keyword.value = t.keyword || '';
    f.priority.value = t.priority || '';
  }
});
document.querySelectorAll('#incident-list .end').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    pauseAutoReload();
    try {
      const res = await fetch(`/api/incidents/${id}/end`, {method: 'POST'});
      const r = await res.json();
      if (r.ok) {
        try {
          await refreshVehicles();
        } catch (err) {
          console.error(err);
        }
      }
      resumeAutoReload(r.ok, { clearPending: !r.ok });
    } catch (err) {
      console.error(err);
      resumeAutoReload(false, { clearPending: true });
    }
  });
});

document.querySelectorAll('#incident-list .delete').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    pauseAutoReload();
    try {
      const res = await fetch(`/api/incidents/${id}`, {method: 'DELETE'});
      const r = await res.json();
      resumeAutoReload(r.ok, { clearPending: !r.ok });
    } catch (err) {
      console.error(err);
      resumeAutoReload(false, { clearPending: true });
    }
  });
});

const evtSource = new EventSource('/events');
evtSource.onmessage = () => {
  if (autoReloadPauseCount > 0) {
    reloadPending = true;
    return;
  }
  window.location.reload();
};
</script>
{% endblock %}
