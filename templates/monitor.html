{% extends 'base.html' %}
{% block head_extra %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
{% endblock %}
{% block content %}
<h1 class="mb-4">Alarmmonitor</h1>
<button id="fullscreen" class="btn btn-secondary mb-3">Vollbild</button>
<div id="latest-incident" class="alert alert-danger display-4" style="display:none;"></div>
<button id="enable-audio" class="btn btn-secondary mb-3">Ton aktivieren</button>
<div class="row">
  <div class="col-md-6">
    <div id="map" style="height:400px;" class="mb-3"></div>
  </div>
  <div class="col-md-6">
    <table class="table table-striped" id="vehicle-table">
        <thead>
            <tr>
                <th>Fahrzeug</th>
                <th>Icon</th>
                <th>Status</th>
                <th>Hinweis</th>
                <th>Ort</th>
            </tr>
        </thead>
        <tbody>
        {% for name, info in vehicles.items() %}
            <tr data-unit="{{ name }}" class="status-{{ info.status }}">
                <td>{{ name }}</td>
                <td class="icon-cell">{% if info.icon %}<img src="{{ url_for('static', filename=info.icon) }}" height="24">{% endif %}</td>
                <td class="status-text">{{ info.status }} - {{ status_text[info.status] }}</td>
                <td class="note">{{ info.note }}</td>
                <td class="location">{{ info.location }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
  </div>
</div>
<audio id="alarm" preload="auto">
  <source src="{{ url_for('static', filename='gong.mp3') }}" type="audio/mpeg">
  <source src="{{ url_for('static', filename='gong.wav') }}" type="audio/wav">
</audio>
{% endblock %}
{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const statusText = {{ status_text|tojson }};
const lastStatus = {};
const lastAlertInfo = {};
let lastAlarmUnit = null;
const vehicleIcons = {};
for (const [unit, info] of Object.entries({{ vehicles|tojson }})) {
    lastStatus[unit] = info.status;
    lastAlertInfo[unit] = {note: info.note, location: info.location};
    if (info.icon) {
        vehicleIcons[unit] = L.icon({iconUrl:`/static/${info.icon}`, iconSize:[32,32], iconAnchor:[16,16]});
    }
}
const alarmSound = document.getElementById('alarm');
const latestDiv = document.getElementById('latest-incident');
const enableBtn = document.getElementById('enable-audio');
let audioUnlocked = false;
const ttsEl = new Audio();
let lastAlarmId = null;
const map = L.map('map').setView([51, 10], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'Â© OpenStreetMap'}).addTo(map);
const vehicleMarkers = {};
const incidentMarkers = {};
const iconBase = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/';
function unlockAudio() {
    alarmSound.play().then(() => {
        alarmSound.pause();
        alarmSound.currentTime = 0;
    }).catch(() => {});
    audioUnlocked = true;
    enableBtn.style.display = 'none';
}
enableBtn.addEventListener('click', unlockAudio, {once: true});
document.addEventListener('touchstart', unlockAudio, {once: true});
document.addEventListener('click', unlockAudio, {once: true});
function fitMapToAll() {
    const markers = [
        ...Object.values(vehicleMarkers),
        ...Object.values(incidentMarkers)
    ].filter(m => m);
    if (markers.length) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.05));
    }
}
const icons = {
  RTW: new L.Icon({iconUrl: iconBase + 'marker-icon-red.png', shadowUrl: iconBase + 'marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]}),
  KTW: new L.Icon({iconUrl: iconBase + 'marker-icon-blue.png', shadowUrl: iconBase + 'marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]}),
  default: new L.Icon({iconUrl: iconBase + 'marker-icon-grey.png', shadowUrl: iconBase + 'marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]}),
};
const incidentIcon = new L.Icon({iconUrl: iconBase + 'marker-icon-green.png', shadowUrl: iconBase + 'marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]});
function getIcon(unit) {
  if (vehicleIcons[unit]) return vehicleIcons[unit];
  if (unit.startsWith('RTW')) return icons.RTW;
  if (unit.startsWith('KTW')) return icons.KTW;
  return icons.default;
}
document.getElementById('fullscreen').addEventListener('click', () => {
  if (document.documentElement.requestFullscreen) {
    document.documentElement.requestFullscreen();
  }
});
if (document.documentElement.requestFullscreen) {
  document.documentElement.requestFullscreen().catch(() => {});
}
document.addEventListener('fullscreenchange', () => {
  const nav = document.querySelector('nav');
  if (document.fullscreenElement) {
    if (nav) nav.style.display = 'none';
  } else {
    if (nav) nav.style.display = '';
  }
});
function speak(text) {
    const t = (text || '').trim();
    if (!t) return;
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(t);
        utterance.lang = 'de-DE';
        window.speechSynthesis.speak(utterance);
        return;
    }
    if (!audioUnlocked) {
        enableBtn.style.display = '';
        return;
    }
    const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=de&q=${encodeURIComponent(t)}`;
    ttsEl.src = url;
    ttsEl.play().catch(err => console.error(err));
}

function triggerAlarm(unit, info) {
    const alarmId = unit + (info.note || '') + (info.location || '');
    if (alarmId === lastAlarmId) return;
    lastAlarmId = alarmId;
    lastAlarmUnit = unit;
    const parts = [unit];
    if (info.note) parts.push(info.note);
    if (info.location) parts.push(info.location);
    const speechText = parts.join('. ');
    const displayText = `${info.note || ''} ${info.location || ''}`.trim();
    if (audioUnlocked) {
        alarmSound.currentTime = 0;
        alarmSound.play().catch(() => {});
        alarmSound.onended = () => {
            setTimeout(() => speak(speechText), 500);
            alarmSound.onended = null;
        };
    } else {
        enableBtn.style.display = '';
        speak(speechText);
    }
    latestDiv.innerHTML = `<strong>${unit}</strong> ${displayText}`;
    latestDiv.style.display = 'block';
    if (info.lat && info.lon) {
        if (vehicleMarkers[unit]) {
            vehicleMarkers[unit].setLatLng([info.lat, info.lon]);
            vehicleMarkers[unit].setIcon(getIcon(unit));
        } else {
            vehicleMarkers[unit] = L.marker([info.lat, info.lon], {icon: getIcon(unit)}).addTo(map).bindPopup(unit);
        }
    }
    fitMapToAll();
}

async function refresh() {
    const [statusRes, incidentsRes] = await Promise.all([
        fetch('/api/status'),
        fetch('/api/incidents')
    ]);
    const data = await statusRes.json();
    const incs = await incidentsRes.json();
    for (const [unit, info] of Object.entries(data)) {
        const row = document.querySelector(`tr[data-unit="${unit}"]`);
        if (row) {
            row.className = `status-${info.status}`;
            row.querySelector('.status-text').textContent = `${info.status} - ${statusText[info.status]}`;
            row.querySelector('.note').textContent = info.note;
            row.querySelector('.location').textContent = info.location;
            const iconCell = row.querySelector('.icon-cell');
            if (info.icon) {
                iconCell.innerHTML = `<img src="/static/${info.icon}" height="24">`;
                vehicleIcons[unit] = L.icon({iconUrl:`/static/${info.icon}`, iconSize:[32,32], iconAnchor:[16,16]});
            } else {
                iconCell.innerHTML = '';
                delete vehicleIcons[unit];
            }
            const prev = lastAlertInfo[unit] || {};
            if (info.status < 3 && (info.note || info.location)) {
                if (info.note !== prev.note || info.location !== prev.location) {
                    triggerAlarm(unit, info);
                }
            } else if (info.status >= 3 && lastAlarmUnit === unit) {
                latestDiv.style.display = 'none';
                lastAlarmUnit = null;
                lastAlarmId = null;
            }
            lastAlertInfo[unit] = {note: info.note, location: info.location};
            lastStatus[unit] = info.status;
            if (info.lat && info.lon) {
                if (vehicleMarkers[unit]) {
                    vehicleMarkers[unit].setLatLng([info.lat, info.lon]);
                    vehicleMarkers[unit].setIcon(getIcon(unit));
                } else {
                    vehicleMarkers[unit] = L.marker([info.lat, info.lon], {icon: getIcon(unit)}).addTo(map).bindPopup(unit);
                }
            } else if (vehicleMarkers[unit]) {
                map.removeLayer(vehicleMarkers[unit]);
                delete vehicleMarkers[unit];
            }
        }
    }
    for (const inc of incs) {
        const loc = inc.location || {};
        if (inc.active && loc.lat && loc.lon) {
            if (incidentMarkers[inc.id]) {
                incidentMarkers[inc.id].setLatLng([loc.lat, loc.lon]);
            } else {
                incidentMarkers[inc.id] = L.marker([loc.lat, loc.lon], {icon: incidentIcon})
                    .addTo(map)
                    .bindPopup(`${inc.keyword} - ${loc.name}`);
            }
        } else if (incidentMarkers[inc.id]) {
            map.removeLayer(incidentMarkers[inc.id]);
            delete incidentMarkers[inc.id];
        }
    }
    fitMapToAll();
}
const evtSource = new EventSource('/events');
evtSource.onmessage = () => refresh();
refresh();
</script>
{% endblock %}
