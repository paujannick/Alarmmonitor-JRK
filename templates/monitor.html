{% extends 'base.html' %}
{% block head_extra %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
{% endblock %}
{% block content %}
<h1 class="mb-4">Alarmmonitor</h1>
<button id="fullscreen" class="btn btn-secondary mb-3">Vollbild</button>
<div id="latest-incident" class="alert alert-danger display-4" style="display:none;"></div>
<div id="map" style="height:400px;" class="mb-3"></div>
<table class="table table-striped" id="vehicle-table">
    <thead>
        <tr>
            <th>Fahrzeug</th>
            <th>Status</th>
            <th>Hinweis</th>
            <th>Ort</th>
        </tr>
    </thead>
    <tbody>
    {% for name, info in vehicles.items() %}
        <tr data-unit="{{ name }}" class="status-{{ info.status }}">
            <td>{{ name }}</td>
            <td class="status-text">{{ status_text[info.status] }}</td>
            <td class="note">{{ info.note }}</td>
            <td class="location">{{ info.location }}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>
<audio id="alarm" src="{{ url_for('static', filename='gong.wav') }}"></audio>
{% endblock %}
{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const statusText = {{ status_text|tojson }};
const lastStatus = {};
for (const [unit, info] of Object.entries({{ vehicles|tojson }})) {
    lastStatus[unit] = info.status;
}
const alarmSound = document.getElementById('alarm');
const latestDiv = document.getElementById('latest-incident');
let map;
const mapDiv = document.getElementById('map');
const vehicleMarkers = {};
document.getElementById('fullscreen').addEventListener('click', () => {
  if (document.documentElement.requestFullscreen) {
    document.documentElement.requestFullscreen();
  }
});
if (document.documentElement.requestFullscreen) {
  document.documentElement.requestFullscreen().catch(() => {});
}
document.addEventListener('fullscreenchange', () => {
  const nav = document.querySelector('nav');
  if (document.fullscreenElement) {
    if (nav) nav.style.display = 'none';
  } else {
    if (nav) nav.style.display = '';
  }
});

function speak(text) {
    if ('speechSynthesis' in window) {
        const msg = new SpeechSynthesisUtterance(text);
        speechSynthesis.speak(msg);
    }
}

function triggerAlarm(unit, info) {
    alarmSound.currentTime = 0;
    alarmSound.play();
    const text = `${info.note || ''} ${info.location || ''}`.trim();
    if (text) {
        speak(text);
    }
    latestDiv.innerHTML = `<strong>${unit}</strong> ${text}`;
    latestDiv.style.display = 'block';
    if (info.lat && info.lon) {
        if (!map) {
            map = L.map('map').setView([info.lat, info.lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '© OpenStreetMap'}).addTo(map);
        } else {
            map.setView([info.lat, info.lon], 13);
        }
        L.marker([info.lat, info.lon]).addTo(map);
    }
}

async function refresh() {
    const res = await fetch('/api/status');
    const data = await res.json();
    for (const [unit, info] of Object.entries(data)) {
        const row = document.querySelector(`tr[data-unit="${unit}"]`);
        if (row) {
            row.className = `status-${info.status}`;
            row.querySelector('.status-text').textContent = statusText[info.status];
            row.querySelector('.note').textContent = info.note;
            row.querySelector('.location').textContent = info.location;
            if (lastStatus[unit] !== undefined && lastStatus[unit] < 3 && info.status >= 3) {
                triggerAlarm(unit, info);
            }
            lastStatus[unit] = info.status;
            if (info.lat && info.lon) {
                if (!map) {
                    map = L.map('map').setView([info.lat, info.lon], 6);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '© OpenStreetMap'}).addTo(map);
                }
                if (vehicleMarkers[unit]) {
                    vehicleMarkers[unit].setLatLng([info.lat, info.lon]);
                } else {
                    vehicleMarkers[unit] = L.marker([info.lat, info.lon]).addTo(map).bindPopup(unit);
                }
            } else if (vehicleMarkers[unit]) {
                map.removeLayer(vehicleMarkers[unit]);
                delete vehicleMarkers[unit];
            }
        }
    }
}
setInterval(refresh, 1000);
</script>
{% endblock %}
