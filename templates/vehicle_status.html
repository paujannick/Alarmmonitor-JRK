{% extends 'base.html' %}
{% block container_class %}container-fluid{% endblock %}
{% block content %}
<h1 class="mb-4">Fahrzeugstatus</h1>
<div class="table-responsive">
  <table class="table table-dark table-striped align-middle" id="vehicle-status-table">
    <thead>
      <tr>
        <th scope="col">Fahrzeug</th>
        <th scope="col">Status</th>
        <th scope="col">Schnellwahl</th>
      </tr>
    </thead>
    <tbody id="vehicle-status-board">
    {% for name, info in vehicles.items() %}
      <tr class="status-row" data-unit="{{ name }}">
        <th scope="row">
          <div class="fw-semibold">{{ name }}</div>
          <div class="text-white-50 small vehicle-callsign">{{ info.callsign or info.name }}</div>
        </th>
        <td class="status-display">
          <span class="badge bg-primary status-label">Status {{ info.status }} – {{ status_text[info.status] }}</span>
        </td>
        <td class="status-buttons">
          <div class="btn-group btn-group-sm" role="group" aria-label="Status Schnellwahl">
            {% for code, text in status_text.items() %}
            <button type="button" class="btn btn-sm status-btn {% if code == info.status %}btn-primary{% else %}btn-outline-secondary{% endif %}" data-status="{{ code }}" title="{{ code }} - {{ text }}">
              {{ code }}
            </button>
            {% endfor %}
          </div>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
<div class="alert alert-danger d-none mt-3" role="alert" id="status-error"></div>
{% endblock %}
{% block scripts %}
<script>
const statusText = {{ status_text|tojson }};
const statusError = document.getElementById('status-error');

function getStatusLabel(status) {
  return `Status ${status} – ${statusText[String(status)] || ''}`;
}

function updateRow(row, info) {
  if (!row || !info) return;
  const status = Number(info.status);
  const badge = row.querySelector('.status-label');
  if (badge) {
    badge.textContent = getStatusLabel(status);
  }
  const callsign = row.querySelector('.vehicle-callsign');
  if (callsign) {
    callsign.textContent = info.callsign || info.name || '';
  }
  row.querySelectorAll('.status-btn').forEach(btn => {
    const btnStatus = Number(btn.dataset.status);
    const isActive = btnStatus === status;
    btn.classList.toggle('btn-primary', isActive);
    btn.classList.toggle('btn-outline-secondary', !isActive);
    btn.disabled = false;
  });
}

async function sendStatus(unit, status, row) {
  try {
    statusError.classList.add('d-none');
    const buttons = row ? Array.from(row.querySelectorAll('.status-btn')) : [];
    buttons.forEach(btn => (btn.disabled = true));
    const response = await fetch('/api/dispatch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ unit, status })
    });
    const data = await response.json();
    if (!response.ok || !data.ok) {
      throw new Error('Status konnte nicht gesetzt werden');
    }
    await refreshStatus();
  } catch (err) {
    statusError.textContent = err.message || 'Status konnte nicht gesetzt werden';
    statusError.classList.remove('d-none');
    if (row) {
      row.querySelectorAll('.status-btn').forEach(btn => (btn.disabled = false));
    }
  }
}

async function refreshStatus() {
  try {
    const response = await fetch('/api/status', {
      cache: 'no-store',
      headers: {
        'Cache-Control': 'no-store'
      }
    });
    if (!response.ok) throw new Error('Konnte Fahrzeugdaten nicht laden');
    const data = await response.json();
    document.querySelectorAll('.status-row').forEach(row => {
      const unit = row.dataset.unit;
      if (data[unit]) {
        updateRow(row, data[unit]);
      }
    });
    statusError.classList.add('d-none');
    statusError.textContent = '';
  } catch (err) {
    statusError.textContent = err.message || 'Konnte Fahrzeugdaten nicht laden';
    statusError.classList.remove('d-none');
  }
}

function setupHandlers() {
  document.querySelectorAll('.status-row').forEach(row => {
    row.addEventListener('click', event => {
      const button = event.target.closest('.status-btn');
      if (!button || button.disabled) return;
      const unit = row.dataset.unit;
      const status = Number(button.dataset.status);
      if (!unit || Number.isNaN(status)) return;
      row.querySelectorAll('.status-btn').forEach(btn => (btn.disabled = true));
      sendStatus(unit, status, row);
    });
  });
}

setupHandlers();
refreshStatus();

let eventSource = null;
let reconnectTimer = null;

function scheduleReconnect() {
  if (reconnectTimer) return;
  reconnectTimer = setTimeout(() => {
    reconnectTimer = null;
    connectEventStream();
  }, 5000);
}

function connectEventStream() {
  if (eventSource) {
    eventSource.close();
  }
  eventSource = new EventSource('/events');
  eventSource.onopen = () => {
    if (reconnectTimer) {
      clearTimeout(reconnectTimer);
      reconnectTimer = null;
    }
    refreshStatus();
  };
  eventSource.onmessage = () => {
    refreshStatus();
  };
  eventSource.onerror = () => {
    if (eventSource) {
      eventSource.close();
      eventSource = null;
    }
    scheduleReconnect();
  };
}

window.addEventListener('beforeunload', () => {
  if (eventSource) {
    eventSource.close();
  }
});

connectEventStream();
setInterval(refreshStatus, 30000);
</script>
{% endblock %}
