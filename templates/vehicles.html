{% extends 'base.html' %}
{% block content %}
<h1 class="mb-4">Fahrzeugverwaltung</h1>
<form id="add-vehicle" class="row g-3 mb-4">
  <div class="col-md-3">
    <label class="form-label" for="vehicle-unit">Kurzname</label>
    <input type="text" name="unit" id="vehicle-unit" class="form-control" required>
  </div>
  <div class="col-md-3">
    <label class="form-label" for="vehicle-name">Name</label>
    <input type="text" name="name" id="vehicle-name" class="form-control">
  </div>
  <div class="col-md-3">
    <label class="form-label" for="vehicle-callsign">Funkrufname</label>
    <input type="text" name="callsign" id="vehicle-callsign" class="form-control">
  </div>
  <div class="col-md-3">
    <label class="form-label" for="vehicle-tts">Sprachausgabe</label>
    <input type="text" name="tts" id="vehicle-tts" class="form-control">
  </div>
  <div class="col-12">
    <label class="form-label" for="vehicle-crew-table">Besatzung</label>
    <table class="table table-sm" id="vehicle-crew-table">
      <thead><tr><th>Name</th><th>Position</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <button type="button" class="btn btn-secondary btn-sm" id="add-crew-row">Mitglied hinzufügen</button>
  </div>
  <div class="col-12">
    <button type="submit" class="btn btn-primary">Hinzufügen</button>
  </div>
</form>
<table class="table table-striped" id="vehicle-list">
  <thead>
    <tr><th>Kurzname</th><th>Name</th><th>Funkrufname</th><th>Besatzung</th><th>Sprachausgabe</th><th>Status</th><th>Icon</th><th>Aktion</th></tr>
  </thead>
  <tbody>
  {% for name, info in vehicles.items() %}
    <tr data-unit="{{ name }}" class="status-{{ info.status }}">
      <td>{{ name }}</td>
      <td><input type="text" class="form-control form-control-sm name" value="{{ info.name }}"></td>
      <td><input type="text" class="form-control form-control-sm callsign" value="{{ info.callsign }}"></td>
      <td>
        <table class="table table-sm mb-1 crew-table">
          <tbody>
          {% for member in info.crew %}
            {% set parts = member.split(':') %}
            <tr>
              <td><input type="text" class="form-control form-control-sm crew-name" value="{{ parts[0] }}"></td>
              <td><input type="text" class="form-control form-control-sm crew-position" value="{{ parts[1]|default('', true) }}"></td>
              <td><button type="button" class="btn btn-sm btn-danger remove-crew">&times;</button></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        <button type="button" class="btn btn-sm btn-secondary add-crew">+</button>
      </td>
      <td><input type="text" class="form-control form-control-sm tts" value="{{ info.tts }}"></td>
      <td>{{ info.status }}</td>
      <td class="icon-cell">
        {% if info.icon %}<img src="{{ url_for('static', filename=info.icon) }}" height="32" class="mb-1">{% endif %}
        <form class="icon-form" enctype="multipart/form-data">
          <label class="form-label visually-hidden" for="icon-{{ loop.index }}">Icon</label>
          <input type="file" name="icon" id="icon-{{ loop.index }}" accept="image/*" class="form-control form-control-sm mb-1">
          <button class="btn btn-sm btn-secondary">Upload</button>
        </form>
      </td>
      <td>
        <button class="btn btn-sm btn-primary save">Speichern</button>
        <button class="btn btn-sm btn-danger delete">Löschen</button>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endblock %}
{% block scripts %}
  <script>
  function createCrewRow(name = '', position = '') {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input type="text" class="form-control form-control-sm crew-name" value="${name}"></td>` +
                   `<td><input type="text" class="form-control form-control-sm crew-position" value="${position}"></td>` +
                   `<td><button type="button" class="btn btn-sm btn-danger remove-crew">&times;</button></td>`;
    return tr;
  }
  function getCrewFromTable(table) {
    const data = [];
    table.querySelectorAll('tbody tr').forEach(row => {
      const name = row.querySelector('.crew-name').value.trim();
      const pos = row.querySelector('.crew-position').value.trim();
      if (name) data.push(pos ? `${name}:${pos}` : name);
    });
    return data;
  }
  const newCrewTable = document.getElementById('vehicle-crew-table');
  document.getElementById('add-crew-row').addEventListener('click', () => {
    newCrewTable.querySelector('tbody').appendChild(createCrewRow());
  });
  newCrewTable.addEventListener('click', e => {
    if (e.target.classList.contains('remove-crew')) {
      e.target.closest('tr').remove();
    }
  });
  const form = document.getElementById('add-vehicle');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(form).entries());
    formData.crew = getCrewFromTable(newCrewTable);
    formData.tts = formData.tts || '';
    const res = await fetch('/api/vehicles', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(formData)
    });
    const r = await res.json();
    if (r.ok) {
      location.reload();
    }
  });

  document.querySelectorAll('#vehicle-list .add-crew').forEach(btn => {
    btn.addEventListener('click', () => {
      const table = btn.previousElementSibling;
      table.querySelector('tbody').appendChild(createCrewRow());
    });
  });
  document.querySelectorAll('#vehicle-list .crew-table').forEach(table => {
    table.addEventListener('click', e => {
      if (e.target.classList.contains('remove-crew')) {
        e.target.closest('tr').remove();
      }
    });
  });

  document.querySelectorAll('#vehicle-list .delete').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const unit = e.target.closest('tr').dataset.unit;
      const res = await fetch(`/api/vehicles/${unit}`, {method:'DELETE'});
      const r = await res.json();
      if (r.ok) {
        e.target.closest('tr').remove();
      }
    });
  });

  document.querySelectorAll('#vehicle-list .save').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const tr = e.target.closest('tr');
      const unit = tr.dataset.unit;
      const payload = {
        name: tr.querySelector('.name').value,
        callsign: tr.querySelector('.callsign').value,
        crew: getCrewFromTable(tr.querySelector('.crew-table')),
        tts: tr.querySelector('.tts').value
      };
      const res = await fetch(`/api/vehicles/${unit}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const r = await res.json();
      if (r.ok) {
        alert('Gespeichert');
      }
    });
  });

  document.querySelectorAll('#vehicle-list .icon-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const unit = form.closest('tr').dataset.unit;
      const fd = new FormData(form);
      const res = await fetch(`/api/vehicles/${unit}/icon`, {
        method: 'POST',
        body: fd
      });
      const r = await res.json();
      if (r.ok) {
        location.reload();
      }
    });
  });
  </script>
{% endblock %}
