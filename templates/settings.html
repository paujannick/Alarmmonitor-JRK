{% extends 'base.html' %}
{% block content %}
<h1>Einstellungen</h1>
<p>
    <a href="{{ url_for('download_log') }}" class="btn btn-secondary">Log herunterladen</a>
</p>

<h2 class="mt-4">Einsatzbereich für Alarmmonitor</h2>
<form id="operation-area-form" class="row g-3 align-items-end">
  <div class="col-md-6">
    <label class="form-label" for="operation-area-name">Stadt / Einsatzbereich</label>
    <input type="text" id="operation-area-name" class="form-control" value="{{ app_settings.operation_area.name }}" placeholder="z.&nbsp;B. Gießen">
  </div>
  <div class="col-md-3">
    <label class="form-label" for="operation-area-zoom">Standard Zoom</label>
    <input type="number" id="operation-area-zoom" class="form-control" value="{{ app_settings.operation_area.zoom }}" min="3" max="18">
  </div>
  <div class="col-md-3">
    <button type="submit" class="btn btn-primary w-100">Einsatzbereich speichern</button>
  </div>
  <div class="col-12">
    <div id="operation-area-feedback" class="alert d-none" role="alert"></div>
    <p id="operation-area-current" class="text-white-50 small mb-0">Aktuelles Zentrum: {{ '%.5f'|format(app_settings.operation_area.lat) }}, {{ '%.5f'|format(app_settings.operation_area.lon) }}</p>
  </div>
</form>

<h2 class="mt-4">Sprachausgabe der Funkrufnamen</h2>
<table class="table" id="tts-table">
  <thead><tr><th>Funkrufname</th><th>Sprachausgabe</th><th>Aktion</th></tr></thead>
  <tbody>
  {% for name, info in vehicles.items() %}
    <tr data-unit="{{ name }}">
      <td>{{ info.callsign }}</td>
      <td>
        <label class="visually-hidden" for="tts-{{ loop.index }}">Sprachausgabe</label>
        <input type="text" id="tts-{{ loop.index }}" class="form-control form-control-sm tts" value="{{ info.tts or info.callsign }}">
      </td>
      <td><button class="btn btn-sm btn-primary save">Speichern</button></td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<h2 class="mt-4">Standorte der Wachen</h2>
<table class="table" id="base-table">
  <thead><tr><th>Fahrzeug</th><th>Wache</th><th>Aktion</th></tr></thead>
  <tbody>
  {% for name, info in vehicles.items() %}
    <tr data-unit="{{ name }}">
      <td>{{ name }}</td>
      <td><input type="text" class="form-control form-control-sm base" value="{{ info.base }}"></td>
      <td><button class="btn btn-sm btn-primary save-base">Speichern</button></td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<h2 class="mt-4">Einsatzvorlagen</h2>
<form id="template-add" class="row g-3 mb-3">
  <div class="col-md-3">
    <input type="text" name="id" class="form-control" placeholder="ID" required>
  </div>
  <div class="col-md-3">
    <input type="text" name="label" class="form-control" placeholder="Bezeichnung" required>
  </div>
  <div class="col-md-3">
    <input type="text" name="keyword" class="form-control" placeholder="Stichwort" required>
  </div>
  <div class="col-md-3">
    <select name="priority" class="form-select">
      <option value="">--</option>
      {% for prio in priorities %}
      <option value="{{ prio }}">{{ prio }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-12">
    <button class="btn btn-primary">Hinzufügen</button>
  </div>
</form>
<table class="table" id="template-table">
  <thead><tr><th>ID</th><th>Bezeichnung</th><th>Stichwort</th><th>Priorität</th><th>Aktion</th></tr></thead>
  <tbody>
  {% for t in templates %}
    <tr data-id="{{ t.id }}">
      <td>{{ t.id }}</td>
      <td><input type="text" class="form-control form-control-sm label" value="{{ t.label }}"></td>
      <td><input type="text" class="form-control form-control-sm keyword" value="{{ t.keyword }}"></td>
      <td>
        <select class="form-select form-select-sm priority">
          <option value="">--</option>
          {% for prio in priorities %}
          <option value="{{ prio }}" {% if prio == t.priority %}selected{% endif %}>{{ prio }}</option>
          {% endfor %}
          {% if t.priority and t.priority not in priorities %}
          <option value="{{ t.priority }}" selected>{{ t.priority }}</option>
          {% endif %}
        </select>
      </td>
      <td>
        <button class="btn btn-sm btn-primary save-template">Speichern</button>
        <button class="btn btn-sm btn-danger delete-template">Löschen</button>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<h2 class="mt-4">Prioritäten</h2>
<form id="priority-form" class="mb-3">
  <table class="table" id="priority-table">
    <thead><tr><th>Bezeichnung</th><th>Aktion</th></tr></thead>
    <tbody>
    {% for prio in priorities %}
      <tr>
        <td><input type="text" class="form-control form-control-sm priority-value" value="{{ prio }}"></td>
        <td><button type="button" class="btn btn-sm btn-danger priority-delete">Löschen</button></td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  <div class="d-flex gap-2">
    <button type="button" class="btn btn-secondary" id="priority-add">Neue Priorität</button>
    <button type="submit" class="btn btn-primary">Speichern</button>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
const operationAreaForm = document.getElementById('operation-area-form');
if (operationAreaForm) {
  operationAreaForm.addEventListener('submit', async event => {
    event.preventDefault();
    const nameInput = document.getElementById('operation-area-name');
    const zoomInput = document.getElementById('operation-area-zoom');
    const feedback = document.getElementById('operation-area-feedback');
    const currentEl = document.getElementById('operation-area-current');
    const payload = {
      name: nameInput ? nameInput.value.trim() : '',
      zoom: zoomInput ? zoomInput.value : undefined,
    };
    if (feedback) {
      feedback.classList.add('d-none');
      feedback.classList.remove('alert-success', 'alert-danger');
      feedback.textContent = '';
    }
    try {
      const response = await fetch('/api/settings/operation-area', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok || !data.ok) {
        const message = (data && data.error) || 'Einsatzbereich konnte nicht gespeichert werden.';
        throw new Error(message);
      }
      if (feedback) {
        feedback.textContent = `Einsatzbereich aktualisiert: ${data.operation_area.name}`;
        feedback.classList.remove('d-none');
        feedback.classList.add('alert', 'alert-success');
      }
      if (nameInput && data.operation_area && data.operation_area.name !== undefined) {
        nameInput.value = data.operation_area.name;
      }
      if (zoomInput && data.operation_area && data.operation_area.zoom !== undefined) {
        zoomInput.value = data.operation_area.zoom;
      }
      if (currentEl && data.operation_area) {
        const lat = Number(data.operation_area.lat);
        const lon = Number(data.operation_area.lon);
        const latText = Number.isFinite(lat) ? lat.toFixed(5) : '--';
        const lonText = Number.isFinite(lon) ? lon.toFixed(5) : '--';
        currentEl.textContent = `Aktuelles Zentrum: ${latText}, ${lonText}`;
      }
    } catch (err) {
      if (feedback) {
        feedback.textContent = err.message || 'Einsatzbereich konnte nicht gespeichert werden.';
        feedback.classList.remove('d-none');
        feedback.classList.add('alert', 'alert-danger');
      } else {
        alert(err.message || 'Einsatzbereich konnte nicht gespeichert werden.');
      }
    }
  });
}

document.querySelectorAll('#tts-table .save').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const tr = e.target.closest('tr');
    const unit = tr.dataset.unit;
    const tts = tr.querySelector('.tts').value;
    const res = await fetch(`/api/vehicles/${unit}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({tts})
    });
    const r = await res.json();
    if (r.ok) {
      alert('Gespeichert');
    }
  });
});

document.querySelectorAll('#base-table .save-base').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const tr = e.target.closest('tr');
    const unit = tr.dataset.unit;
    const base = tr.querySelector('.base').value;
    const res = await fetch(`/api/vehicles/${unit}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({base})
    });
    const r = await res.json();
    if (r.ok) {
      alert('Gespeichert');
    }
  });
});

const tplForm = document.getElementById('template-add');
tplForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(tplForm).entries());
  const res = await fetch('/api/templates', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });
  const r = await res.json();
  if (r.ok) {
    location.reload();
  }
});

document.querySelectorAll('#template-table .save-template').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    const payload = {
      id,
      label: tr.querySelector('.label').value,
      keyword: tr.querySelector('.keyword').value,
      priority: tr.querySelector('.priority').value
    };
    const res = await fetch('/api/templates', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    const r = await res.json();
    if (r.ok) {
      alert('Gespeichert');
    }
  });
});

document.querySelectorAll('#template-table .delete-template').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    const res = await fetch(`/api/templates/${id}`, {method: 'DELETE'});
    const r = await res.json();
    if (r.ok) {
      tr.remove();
    }
  });
});

const priorityTableBody = document.querySelector('#priority-table tbody');

function escapePriorityValue(value) {
  return value.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
}

function addPriorityRow(value = '') {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" class="form-control form-control-sm priority-value" value="${escapePriorityValue(value)}"></td>
    <td><button type="button" class="btn btn-sm btn-danger priority-delete">Löschen</button></td>
  `;
  priorityTableBody.appendChild(tr);
}

document.getElementById('priority-add').addEventListener('click', () => {
  addPriorityRow();
});

priorityTableBody.addEventListener('click', (e) => {
  if (e.target.classList.contains('priority-delete')) {
    e.target.closest('tr').remove();
  }
});

if (!priorityTableBody.children.length) {
  addPriorityRow();
}

document.getElementById('priority-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const values = Array.from(priorityTableBody.querySelectorAll('.priority-value'))
    .map(input => input.value.trim())
    .filter((value, index, arr) => value && arr.indexOf(value) === index);
  const res = await fetch('/api/priorities', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({priorities: values})
  });
  const result = await res.json();
  if (result.ok) {
    location.reload();
  } else {
    alert('Prioritäten konnten nicht gespeichert werden.');
  }
});
</script>
{% endblock %}
