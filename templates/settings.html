{% extends 'base.html' %}
{% set network = app_settings.network or {} %}
{% set monitor_settings = app_settings.monitor or {} %}
{% set monitor_defaults = monitor_defaults or {} %}
{% set gong_volume = monitor_settings.gong_volume if monitor_settings.gong_volume is not none else monitor_defaults.gong_volume if monitor_defaults.gong_volume is not none else 1.0 %}
{% block content %}
<div class="page-header d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
  <div>
    <h1 class="mb-1">Einstellungen</h1>
    <p class="text-body-secondary mb-0">Passe Einsatzbereich, Monitor, Netzwerk und Vorlagen an deine Bedürfnisse an.</p>
  </div>
  <a href="{{ url_for('download_log') }}" class="btn btn-outline-light">Log herunterladen</a>
</div>

<div class="row gy-4">
  <div class="col-12 col-xl-6">
    <section class="card card-panel h-100">
      <div class="card-header">
        <h2 class="h5 mb-1">Einsatzbereich für Alarmmonitor</h2>
        <p class="text-body-secondary small mb-0">Legt den Kartenausschnitt und das Zentrum für Einsätze fest.</p>
      </div>
      <div class="card-body">
        <form id="operation-area-form" class="row g-3 align-items-end" autocomplete="off">
          <div class="col-12">
            <label class="form-label" for="operation-area-name">Stadt / Einsatzbereich</label>
            <input type="text" id="operation-area-name" class="form-control" value="{{ app_settings.operation_area.name }}" placeholder="z.&nbsp;B. Gießen">
          </div>
          <div class="col-sm-6">
            <label class="form-label" for="operation-area-zoom">Standard Zoom</label>
            <input type="number" id="operation-area-zoom" class="form-control" value="{{ app_settings.operation_area.zoom }}" min="3" max="18">
          </div>
          <div class="col-sm-6 d-grid">
            <button type="submit" class="btn btn-primary">Einsatzbereich speichern</button>
          </div>
          <div class="col-12">
            <div id="operation-area-feedback" class="alert d-none" role="alert"></div>
            <p id="operation-area-current" class="text-body-secondary small mb-0">Aktuelles Zentrum: {{ '%.5f'|format(app_settings.operation_area.lat) }}, {{ '%.5f'|format(app_settings.operation_area.lon) }}</p>
          </div>
        </form>
      </div>
    </section>
  </div>

  <div class="col-12 col-xl-6">
    <section class="card card-panel h-100">
      <div class="card-header d-flex flex-wrap justify-content-between align-items-start gap-3">
        <div>
          <h2 class="h5 mb-1">Netzwerkverwaltung</h2>
          <p class="text-body-secondary small mb-0">Das WLAN des Alarmmonitors wird über einen TP-Link Reise Router bereitgestellt.</p>
        </div>
        {% if network.admin_url %}
        <a id="network-open-button" class="btn btn-outline-warning" href="{{ network.admin_url }}" target="_blank" rel="noopener">Router öffnen</a>
        {% endif %}
      </div>
      <div class="card-body">
        <form id="network-settings-form" class="row g-3" autocomplete="off">
          <div class="col-sm-6">
            <label class="form-label" for="network-router-name">Gerätename</label>
            <input type="text" id="network-router-name" name="router_name" class="form-control" value="{{ network.router_name or '' }}" placeholder="TP-Link Reise Router">
          </div>
          <div class="col-sm-6">
            <label class="form-label" for="network-admin-url">Administrations-URL</label>
            <input type="url" id="network-admin-url" name="admin_url" class="form-control" value="{{ network.admin_url or '' }}" placeholder="http://tplinkwifi.net">
          </div>
          <div class="col-12">
            <label class="form-label" for="network-notes">Hinweis (z.&nbsp;B. Zugangsdaten)</label>
            <textarea id="network-notes" name="notes" class="form-control" rows="2" placeholder="Passwort steht auf der Unterseite.">{{ network.notes or '' }}</textarea>
          </div>
          <div class="col-12 d-flex flex-wrap justify-content-between align-items-center gap-3">
            <p class="text-body-secondary small mb-0">Die WLAN-Konfiguration erfolgt direkt über den Router. Verbinde dich mit dem TP-Link WLAN, öffne die Administrations-URL und folge dem Einrichtungsassistenten.</p>
            <button type="submit" class="btn btn-primary">Netzwerk speichern</button>
          </div>
        </form>
        <div id="network-settings-feedback" class="alert d-none mt-3" role="alert"></div>
      </div>
    </section>
  </div>

  <div class="col-12 col-xl-6">
    <section class="card card-panel h-100">
      <div class="card-header">
        <h2 class="h5 mb-1">Monitor &amp; Anzeigen</h2>
        <p class="text-body-secondary small mb-0">Steuert die Zusatzinformationen auf dem großen Monitor.</p>
      </div>
      <div class="card-body">
        <form id="monitor-settings-form" class="d-flex flex-column gap-4" autocomplete="off">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="monitor-show-weather" name="show_weather" {% if monitor_settings.show_weather %}checked{% endif %}>
                <label class="form-check-label" for="monitor-show-weather">Wetter-Kachel anzeigen</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="monitor-show-map" name="show_map" {% if monitor_settings.show_map %}checked{% endif %}>
                <label class="form-check-label" for="monitor-show-map">Karte anzeigen</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="monitor-show-incidents" name="show_incidents" {% if monitor_settings.show_incidents %}checked{% endif %}>
                <label class="form-check-label" for="monitor-show-incidents">Aktive Einsätze anzeigen</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="monitor-clock-seconds" name="clock_with_seconds" {% if monitor_settings.clock_with_seconds %}checked{% endif %}>
                <label class="form-check-label" for="monitor-clock-seconds">Sekunden in der Uhr anzeigen</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="monitor-auto-launch-browser" name="auto_launch_browser" {% if monitor_settings.auto_launch_browser %}checked{% endif %}>
                <label class="form-check-label" for="monitor-auto-launch-browser">Browser beim Start automatisch öffnen</label>
              </div>
            </div>
          </div>
          <div class="row g-3 align-items-center">
            <div class="col-sm-6">
              <label class="form-label" for="monitor-accent-color">Akzentfarbe</label>
              <input type="color" id="monitor-accent-color" name="accent_color" class="form-control form-control-color" value="{{ monitor_settings.accent_color or monitor_defaults.accent_color or '#0d6efd' }}">
              <div class="form-text">Bestimme die Farbe für Highlights und Buttons.</div>
            </div>
            <div class="col-sm-6">
              <label class="form-label" for="monitor-audio-mode">Audio-Modus</label>
              <select id="monitor-audio-mode" name="audio_mode" class="form-select">
                <option value="gong-and-tts" {% if monitor_settings.audio_mode == 'gong-and-tts' or not monitor_settings.audio_mode %}selected{% endif %}>Gong &amp; Sprachausgabe</option>
                <option value="gong-only" {% if monitor_settings.audio_mode == 'gong-only' %}selected{% endif %}>Nur Gong</option>
                <option value="tts-only" {% if monitor_settings.audio_mode == 'tts-only' %}selected{% endif %}>Nur Sprachausgabe</option>
                <option value="mute" {% if monitor_settings.audio_mode == 'mute' %}selected{% endif %}>Stumm</option>
              </select>
              <div class="form-text">Passe die Audio-Ausgabe an die Einsatzumgebung an.</div>
            </div>
          </div>
          <div class="row g-3 align-items-center">
            <div class="col-sm-8">
              <label class="form-label" for="monitor-gong-volume">Gong-Lautstärke</label>
              <input type="range" class="form-range" id="monitor-gong-volume" name="gong_volume" min="0" max="100" step="5" value="{{ (gong_volume * 100)|round(0)|int }}">
            </div>
            <div class="col-sm-4 text-sm-end">
              <p class="form-text mb-0"><span id="monitor-gong-volume-value">{{ (gong_volume * 100)|round(0)|int }}</span>&nbsp;%</p>
            </div>
          </div>
          <p class="text-body-secondary small mb-0">Änderungen werden nach dem Speichern auf dem Monitor wirksam. Ein offenes Dashboard übernimmt die neuen Einstellungen automatisch nach dem nächsten Refresh.</p>
          <div class="d-flex flex-wrap gap-2">
            <button type="submit" class="btn btn-primary">Monitor-Einstellungen speichern</button>
            <button type="button" class="btn btn-outline-light" id="monitor-reset-defaults">Auf Standard zurücksetzen</button>
          </div>
          <div id="monitor-settings-feedback" class="alert d-none" role="alert"></div>
        </form>
      </div>
    </section>
  </div>

  <div class="col-12 col-xl-6">
    <section class="card card-panel h-100">
      <div class="card-header">
        <h2 class="h5 mb-1">Standorte der Wachen</h2>
        <p class="text-body-secondary small mb-0">Definiert die Heimstandorte für die Fahrzeuge.</p>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle" id="base-table">
            <thead>
              <tr><th>Fahrzeug</th><th>Wache</th><th class="text-end">Aktion</th></tr>
            </thead>
            <tbody>
            {% for name, info in vehicles.items() %}
              <tr data-unit="{{ name }}">
                <td class="fw-semibold">{{ name }}</td>
                <td><input type="text" class="form-control form-control-sm base" value="{{ info.base }}" placeholder="z.&nbsp;B. Rettungswache Lich"></td>
                <td class="text-end"><button class="btn btn-sm btn-primary save-base">Speichern</button></td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <div class="col-12">
    <section class="card card-panel">
      <div class="card-header">
        <h2 class="h5 mb-1">Sprachausgabe der Funkrufnamen</h2>
        <p class="text-body-secondary small mb-0">Passe an, wie Fahrzeuge in Sprachausgaben ausgesprochen werden.</p>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle" id="tts-table">
            <thead><tr><th>Funkrufname</th><th>Sprachausgabe</th><th class="text-end">Aktion</th></tr></thead>
            <tbody>
            {% for name, info in vehicles.items() %}
              <tr data-unit="{{ name }}">
                <td>{{ info.callsign }}</td>
                <td>
                  <label class="visually-hidden" for="tts-{{ loop.index }}">Sprachausgabe</label>
                  <input type="text" id="tts-{{ loop.index }}" class="form-control form-control-sm tts" value="{{ info.tts or info.callsign }}">
                </td>
                <td class="text-end"><button class="btn btn-sm btn-primary save">Speichern</button></td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <div class="col-12">
    <section class="card card-panel">
      <div class="card-header">
        <h2 class="h5 mb-1">Einsatzvorlagen</h2>
        <p class="text-body-secondary small mb-0">Bereite häufige Einsatzszenarien vor, um sie schneller auszulösen.</p>
      </div>
      <div class="card-body">
        <form id="template-add" class="row g-3 mb-4">
          <div class="col-md-3">
            <label class="form-label visually-hidden" for="template-id">ID</label>
            <input type="text" id="template-id" name="id" class="form-control" placeholder="ID" required>
          </div>
          <div class="col-md-3">
            <label class="form-label visually-hidden" for="template-label">Bezeichnung</label>
            <input type="text" id="template-label" name="label" class="form-control" placeholder="Bezeichnung" required>
          </div>
          <div class="col-md-3">
            <label class="form-label visually-hidden" for="template-keyword">Stichwort</label>
            <input type="text" id="template-keyword" name="keyword" class="form-control" placeholder="Stichwort" required>
          </div>
          <div class="col-md-3">
            <label class="form-label visually-hidden" for="template-priority">Priorität</label>
            <select id="template-priority" name="priority" class="form-select">
              <option value="">--</option>
              {% for prio in priorities %}
              <option value="{{ prio }}">{{ prio }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12">
            <button class="btn btn-primary">Vorlage hinzufügen</button>
          </div>
        </form>
        <div class="table-responsive">
          <table class="table align-middle" id="template-table">
            <thead><tr><th>ID</th><th>Bezeichnung</th><th>Stichwort</th><th>Priorität</th><th class="text-end">Aktion</th></tr></thead>
            <tbody>
            {% for t in templates %}
              <tr data-id="{{ t.id }}">
                <td class="fw-semibold">{{ t.id }}</td>
                <td><input type="text" class="form-control form-control-sm label" value="{{ t.label }}"></td>
                <td><input type="text" class="form-control form-control-sm keyword" value="{{ t.keyword }}"></td>
                <td>
                  <select class="form-select form-select-sm priority">
                    <option value="">--</option>
                    {% for prio in priorities %}
                    <option value="{{ prio }}" {% if prio == t.priority %}selected{% endif %}>{{ prio }}</option>
                    {% endfor %}
                    {% if t.priority and t.priority not in priorities %}
                    <option value="{{ t.priority }}" selected>{{ t.priority }}</option>
                    {% endif %}
                  </select>
                </td>
                <td class="text-end">
                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-primary save-template">Speichern</button>
                    <button class="btn btn-danger delete-template">Löschen</button>
                  </div>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <div class="col-12 col-lg-6">
    <section class="card card-panel h-100">
      <div class="card-header">
        <h2 class="h5 mb-1">Prioritäten</h2>
        <p class="text-body-secondary small mb-0">Definiert die verfügbaren Prioritätsstufen für Einsätze.</p>
      </div>
      <div class="card-body">
        <form id="priority-form" class="d-flex flex-column gap-3">
          <div class="table-responsive">
            <table class="table align-middle" id="priority-table">
              <thead><tr><th>Bezeichnung</th><th class="text-end">Aktion</th></tr></thead>
              <tbody>
              {% for prio in priorities %}
                <tr>
                  <td><input type="text" class="form-control form-control-sm priority-value" value="{{ prio }}"></td>
                  <td class="text-end"><button type="button" class="btn btn-sm btn-danger priority-delete">Löschen</button></td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-outline-light" id="priority-add">Neue Priorität</button>
            <button type="submit" class="btn btn-primary">Prioritäten speichern</button>
          </div>
        </form>
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showFeedback(target, message, type = 'success') {
  if (!target) return;
  target.textContent = message;
  target.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-warning');
  target.classList.add(`alert-${type}`);
  const previous = Number(target.dataset.timeout || 0);
  if (previous) {
    clearTimeout(previous);
  }
  const timeout = window.setTimeout(() => {
    target.classList.add('d-none');
    target.dataset.timeout = '';
  }, 5000);
  target.dataset.timeout = timeout;
}

const monitorForm = document.getElementById('monitor-settings-form');
const monitorFeedback = document.getElementById('monitor-settings-feedback');
const monitorDefaultsData = {{ monitor_defaults|tojson }} || {};
const monitorAccentInput = document.getElementById('monitor-accent-color');
const monitorAudioMode = document.getElementById('monitor-audio-mode');
const monitorVolumeInput = document.getElementById('monitor-gong-volume');
const monitorVolumeLabel = document.getElementById('monitor-gong-volume-value');
const monitorResetButton = document.getElementById('monitor-reset-defaults');

function hexToRgbString(value) {
  if (typeof value !== 'string') return null;
  const trimmed = value.trim();
  const match = /^#?([0-9a-f]{3}|[0-9a-f]{6})$/i.exec(trimmed);
  if (!match) return null;
  let hex = match[1];
  if (hex.length === 3) {
    hex = hex.split('').map(ch => ch + ch).join('');
  }
  const r = parseInt(hex.slice(0, 2), 16);
  const g = parseInt(hex.slice(2, 4), 16);
  const b = parseInt(hex.slice(4, 6), 16);
  if ([r, g, b].some(component => Number.isNaN(component))) return null;
  return `${r}, ${g}, ${b}`;
}

function applyAccentPreview(accent, rgb) {
  if (!accent) return;
  const target = document.body || document.documentElement;
  if (!target || !target.style) return;
  target.style.setProperty('--accent-color', accent);
  const rgbValue = rgb || hexToRgbString(accent);
  if (rgbValue) {
    target.style.setProperty('--accent-color-rgb', rgbValue);
  }
}

function updateVolumeLabel(value) {
  if (!monitorVolumeLabel) return;
  const numeric = Number(value);
  const safeValue = Number.isFinite(numeric) ? Math.max(0, Math.min(100, Math.round(numeric))) : 0;
  monitorVolumeLabel.textContent = String(safeValue);
}

async function submitMonitorSettings(event) {
  event.preventDefault();
  if (!monitorForm) return;
  const submitButton = monitorForm.querySelector('button[type="submit"]');
  const controlsToDisable = [submitButton, monitorResetButton];
  controlsToDisable.forEach(btn => {
    if (btn) {
      btn.disabled = true;
    }
  });
  const getChecked = id => Boolean(document.getElementById(id)?.checked);
  const payload = {
    show_weather: getChecked('monitor-show-weather'),
    show_map: getChecked('monitor-show-map'),
    show_incidents: getChecked('monitor-show-incidents'),
    clock_with_seconds: getChecked('monitor-clock-seconds'),
    auto_launch_browser: getChecked('monitor-auto-launch-browser'),
    accent_color: monitorAccentInput ? monitorAccentInput.value : '',
    audio_mode: monitorAudioMode ? monitorAudioMode.value : '',
  };
  if (monitorVolumeInput) {
    const rawVolume = Number(monitorVolumeInput.value);
    if (Number.isFinite(rawVolume)) {
      payload.gong_volume = Math.max(0, Math.min(100, rawVolume)) / 100;
    }
  }
  try {
    const response = await fetch('/api/settings/monitor', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const data = await response.json().catch(() => ({}));
    if (!response.ok || !data.ok) {
      throw new Error((data && data.error) || 'Monitor-Einstellungen konnten nicht gespeichert werden.');
    }
    showFeedback(monitorFeedback, 'Monitor-Einstellungen gespeichert.');
    if (data.monitor) {
      const monitorData = data.monitor;
      const checkboxMap = {
        show_weather: 'monitor-show-weather',
        show_map: 'monitor-show-map',
        show_incidents: 'monitor-show-incidents',
        clock_with_seconds: 'monitor-clock-seconds',
        auto_launch_browser: 'monitor-auto-launch-browser',
      };
      Object.entries(checkboxMap).forEach(([key, id]) => {
        if (key in monitorData) {
          const el = document.getElementById(id);
          if (el) {
            el.checked = Boolean(monitorData[key]);
          }
        }
      });
      if (monitorAccentInput && monitorData.accent_color) {
        monitorAccentInput.value = monitorData.accent_color;
      }
      if (monitorAudioMode && monitorData.audio_mode) {
        monitorAudioMode.value = monitorData.audio_mode;
      }
      if (monitorVolumeInput && monitorData.gong_volume !== undefined) {
        const volumePercent = Math.round(Math.max(0, Math.min(1, Number(monitorData.gong_volume))) * 100);
        monitorVolumeInput.value = String(volumePercent);
        updateVolumeLabel(volumePercent);
      }
      applyAccentPreview(monitorData.accent_color, monitorData.accent_color_rgb);
    }
  } catch (err) {
    showFeedback(monitorFeedback, err.message || 'Monitor-Einstellungen konnten nicht gespeichert werden.', 'danger');
  } finally {
    controlsToDisable.forEach(btn => {
      if (btn) {
        btn.disabled = false;
      }
    });
  }
}

if (monitorForm) {
  monitorForm.addEventListener('submit', submitMonitorSettings);
}

if (monitorVolumeInput) {
  monitorVolumeInput.addEventListener('input', event => {
    updateVolumeLabel(event.target.value);
  });
  updateVolumeLabel(monitorVolumeInput.value);
}

if (monitorResetButton && monitorForm) {
  monitorResetButton.addEventListener('click', event => {
    event.preventDefault();
    const defaults = monitorDefaultsData || {};
    const setChecked = (id, value) => {
      const el = document.getElementById(id);
      if (el) {
        el.checked = Boolean(value);
      }
    };
    setChecked('monitor-show-weather', defaults.show_weather !== false);
    setChecked('monitor-show-map', defaults.show_map !== false);
    setChecked('monitor-show-incidents', defaults.show_incidents !== false);
    setChecked('monitor-clock-seconds', Boolean(defaults.clock_with_seconds));
    setChecked('monitor-auto-launch-browser', Boolean(defaults.auto_launch_browser));
    if (monitorAccentInput) {
      monitorAccentInput.value = defaults.accent_color || '#0d6efd';
    }
    if (monitorAudioMode) {
      monitorAudioMode.value = defaults.audio_mode || 'gong-and-tts';
    }
    if (monitorVolumeInput) {
      const defaultVolume = Number(defaults.gong_volume);
      const volumePercent = Number.isFinite(defaultVolume)
        ? Math.round(Math.max(0, Math.min(1, defaultVolume)) * 100)
        : 100;
      monitorVolumeInput.value = String(volumePercent);
      updateVolumeLabel(volumePercent);
    }
    monitorForm.requestSubmit();
  });
}

const operationAreaForm = document.getElementById('operation-area-form');
if (operationAreaForm) {
  operationAreaForm.addEventListener('submit', async event => {
    event.preventDefault();
    const nameInput = document.getElementById('operation-area-name');
    const zoomInput = document.getElementById('operation-area-zoom');
    const feedback = document.getElementById('operation-area-feedback');
    const currentEl = document.getElementById('operation-area-current');
    const payload = {
      name: nameInput ? nameInput.value.trim() : '',
      zoom: zoomInput ? zoomInput.value : undefined,
    };
    try {
      const response = await fetch('/api/settings/operation-area', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok || !data.ok) {
        throw new Error((data && data.error) || 'Einsatzbereich konnte nicht gespeichert werden.');
      }
      if (feedback) {
        showFeedback(feedback, 'Einsatzbereich gespeichert.');
      }
      if (currentEl && data.operation_area) {
        const { lat, lon } = data.operation_area;
        currentEl.textContent = `Aktuelles Zentrum: ${Number(lat).toFixed(5)}, ${Number(lon).toFixed(5)}`;
      }
    } catch (err) {
      if (feedback) {
        showFeedback(feedback, err.message || 'Einsatzbereich konnte nicht gespeichert werden.', 'danger');
      }
    }
  });
}

const networkForm = document.getElementById('network-settings-form');
if (networkForm) {
  const feedback = document.getElementById('network-settings-feedback');
  networkForm.addEventListener('submit', async event => {
    event.preventDefault();
    const formData = new FormData(networkForm);
    const payload = Object.fromEntries(formData.entries());
    try {
      const response = await fetch('/api/settings/network', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok || !data.ok) {
        throw new Error((data && data.error) || 'Netzwerkeinstellungen konnten nicht gespeichert werden.');
      }
      showFeedback(feedback, 'Netzwerkhinweise gespeichert.');
      if (data.network && data.network.admin_url) {
        const openButton = document.getElementById('network-open-button');
        if (openButton) {
          openButton.href = data.network.admin_url;
        } else {
          const buttonWrapper = networkForm.closest('.card')?.querySelector('.card-header');
          if (buttonWrapper) {
            const link = document.createElement('a');
            link.id = 'network-open-button';
            link.className = 'btn btn-outline-warning';
            link.href = data.network.admin_url;
            link.target = '_blank';
            link.rel = 'noopener';
            link.textContent = 'Router öffnen';
            buttonWrapper.appendChild(link);
          }
        }
      }
    } catch (err) {
      showFeedback(feedback, err.message || 'Netzwerkeinstellungen konnten nicht gespeichert werden.', 'danger');
    }
  });
}
</script>
{% endblock %}
